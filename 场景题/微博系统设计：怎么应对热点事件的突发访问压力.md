# å¾®åšç³»ç»Ÿè®¾è®¡ï¼šæ€Žä¹ˆåº”å¯¹çƒ­ç‚¹äº‹ä»¶çš„çªå‘è®¿é—®åŽ‹åŠ›

:::info
å¾®åšï¼ˆmicroblogï¼‰æ˜¯ä¸€ç§å…è®¸ç”¨æˆ·å³æ—¶æ›´æ–°ç®€çŸ­æ–‡æœ¬ï¼ˆæ¯”å¦‚140ä¸ªå­—ç¬¦ï¼‰ï¼Œå¹¶å¯ä»¥å…¬å¼€å‘å¸ƒçš„å¾®åž‹åšå®¢å½¢å¼ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥å¼€å‘ä¸€ä¸ªé¢å‘å…¨çƒç”¨æˆ·ã€å¯ä»¥æ”¯æŒ10äº¿çº§ç”¨æˆ·ä½“é‡çš„å¾®åšç³»ç»Ÿï¼Œç³»ç»Ÿåç§°ä¸ºâ€œWeitterâ€ã€‚
æˆ‘ä»¬çŸ¥é“ï¼Œå¾®åšæœ‰ä¸€ä¸ªé‡è¦ç‰¹ç‚¹å°±æ˜¯éƒ¨åˆ†æ˜Žæ˜Ÿå¤§Væ‹¥æœ‰å¤§é‡çš„ç²‰ä¸ã€‚å¦‚æžœæ˜Žæ˜Ÿä»¬å‘å¸ƒä¸€æ¡æ¯”è¾ƒæœ‰è¯é¢˜æ€§çš„ä¸ªäººèŠ±è¾¹æ–°é—»ï¼Œæ¯”å¦‚å®£å¸ƒç»“å©šæˆ–è€…ç¦»å©šï¼Œå°±ä¼šå¼•èµ·ç²‰ä¸ä»¬å¤§é‡çš„è½¬å‘å’Œè¯„è®ºï¼Œè¿›è€Œå¼•èµ·æ›´å¤§è§„æ¨¡çš„ç”¨æˆ·é˜…è¯»å’Œä¼ æ’­ã€‚
è¿™ç§çªå‘çš„å•ä¸€çƒ­ç‚¹äº‹ä»¶å¯¼è‡´çš„é«˜å¹¶å‘è®¿é—®ä¼šç»™ç³»ç»Ÿå¸¦æ¥æžå¤§çš„è´Ÿè½½åŽ‹åŠ›ï¼Œå¤„ç†ä¸å½“ç”šè‡³ä¼šå¯¼è‡´[ç³»ç»Ÿå´©æºƒ](https://so.csdn.net/so/search?q=%E7%B3%BB%E7%BB%9F%E5%B4%A9%E6%BA%83&spm=1001.2101.3001.7020)ã€‚è€Œè¿™ç§å´©æºƒåˆä¼šæˆä¸ºäº‹ä»¶çƒ­ç‚¹çš„ä¸€éƒ¨åˆ†ï¼Œè¿›è€Œå¼•æ¥æ›´å¤šçš„å›´è§‚å’Œä¼ æ’­ã€‚
å› æ­¤ï¼ŒWeitterçš„æŠ€æœ¯æŒ‘æˆ˜ï¼Œä¸€æ–¹é¢æ˜¯å¾®åšè¿™æ ·ç±»ä¼¼çš„ä¿¡æ¯æµ[ç³»ç»Ÿæž¶æž„](https://so.csdn.net/so/search?q=%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84&spm=1001.2101.3001.7020)æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Œå¦ä¸€æ–¹é¢å°±æ˜¯å¦‚ä½•è§£å†³å¤§Vä»¬çš„çƒ­ç‚¹æ¶ˆæ¯äº§ç”Ÿçš„çªå‘é«˜å¹¶å‘è®¿é—®åŽ‹åŠ›ï¼Œä¿éšœç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™æ ·çš„ç³»ç»Ÿæž¶æž„è¯¥æ€Žä¹ˆè®¾è®¡ã€‚
:::

### **1 éœ€æ±‚åˆ†æž**
Weitterçš„æ ¸å¿ƒåŠŸèƒ½åªæœ‰ä¸‰ä¸ªï¼šå‘å¾®åšï¼Œå…³æ³¨å¥½å‹ï¼Œåˆ·å¾®åšã€‚
![1720609069301-edb12c53-b084-4cd7-aef7-027920f67492.png](./img/TtEZ-MYG9c03xyky/1720609069301-edb12c53-b084-4cd7-aef7-027920f67492-509701.png)

1. å‘å¾®åšï¼šç”¨æˆ·å¯ä»¥å‘è¡¨å¾®åšï¼Œå†…å®¹åŒ…å«ä¸è¶…è¿‡140ä¸ªå­—çš„æ–‡æœ¬ï¼Œå¯ä»¥åŒ…å«å›¾ç‰‡å’Œè§†é¢‘ã€‚
2. å…³æ³¨å¥½å‹ï¼šç”¨æˆ·å¯ä»¥å…³æ³¨å…¶ä»–ç”¨æˆ·ã€‚
3. åˆ·å¾®åšï¼šç”¨æˆ·æ‰“å¼€è‡ªå·±çš„å¾®åšä¸»é¡µï¼Œä¸»é¡µæ˜¾ç¤ºç”¨æˆ·å…³æ³¨çš„å¥½å‹æœ€è¿‘å‘è¡¨çš„å¾®åšï¼›ç”¨æˆ·å‘ä¸‹æ»‘åŠ¨é¡µé¢ï¼ˆæˆ–è€…ç‚¹åˆ·æ–°æŒ‰é’®ï¼‰ï¼Œä¸»é¡µå°†æ›´æ–°å…³æ³¨å¥½å‹çš„æœ€æ–°å¾®åšï¼Œä¸”æœ€æ–°çš„å¾®åšæ˜¾ç¤ºåœ¨æœ€ä¸Šæ–¹ï¼›ä¸»é¡µä¸€æ¬¡æ˜¾ç¤º20æ¡å¾®åšï¼Œå½“ç”¨æˆ·æ»‘åŠ¨åˆ°ä¸»é¡µåº•éƒ¨åŽï¼Œç»§ç»­å‘ä¸Šæ»‘åŠ¨ï¼Œä¼šæŒ‰ç…§æ—¶é—´é¡ºåºï¼Œæ˜¾ç¤ºå½“å‰é¡µé¢åŽç»­çš„20æ¡å¾®åšã€‚
4. æ­¤å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥æ”¶è—ã€è½¬å‘ã€è¯„è®ºå¾®åšã€‚

#### **1. æ€§èƒ½æŒ‡æ ‡ä¼°ç®—**
ç³»ç»ŸæŒ‰10äº¿ç”¨æˆ·è®¾è®¡ï¼ŒæŒ‰20%æ—¥æ´»ä¼°è®¡ï¼Œå¤§çº¦æœ‰2äº¿æ—¥æ´»ç”¨æˆ·ï¼ˆDAUï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªæ—¥æ´»ç”¨æˆ·æ¯å¤©å‘è¡¨ä¸€æ¡å¾®åšï¼Œå¹¶ä¸”å¹³å‡æœ‰500ä¸ªå…³æ³¨è€…ã€‚
è€Œå¯¹äºŽ**å‘å¾®åšæ‰€éœ€çš„å­˜å‚¨ç©ºé—´**ï¼Œæˆ‘ä»¬åšå¦‚ä¸‹ä¼°ç®—ã€‚

- **æ–‡æœ¬å†…å®¹å­˜å‚¨ç©ºé—´**

éµå¾ªæƒ¯ä¾‹ï¼Œæ¯æ¡å¾®åš140ä¸ªå­—ï¼Œå¦‚æžœä»¥UTF8ç¼–ç å­˜å‚¨æ±‰å­—è®¡ç®—ï¼Œåˆ™æ¯æ¡å¾®åšéœ€è¦small140times3=420ð‘ ð‘šð‘Žð‘™ð‘™140ð‘¡ð‘–ð‘šð‘’ð‘ 3=420ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚é™¤äº†æ±‰å­—å†…å®¹ä»¥å¤–ï¼Œæ¯æ¡å¾®åšè¿˜éœ€è¦å­˜å‚¨å¾®åšIDã€ç”¨æˆ·IDã€æ—¶é—´æˆ³ã€ç»çº¬åº¦ç­‰æ•°æ®ï¼ŒæŒ‰80ä¸ªå­—èŠ‚è®¡ç®—ã€‚é‚£ä¹ˆæ¯å¤©æ–°å‘è¡¨å¾®åšæ–‡æœ¬å†…å®¹éœ€è¦çš„å­˜å‚¨ç©ºé—´ä¸º100GBã€‚
small2äº¿times(420B+80B)=100GB/å¤©ð‘ ð‘šð‘Žð‘™ð‘™2äº¿ð‘¡ð‘–ð‘šð‘’ð‘ (420ðµ+80ðµ)=100ðºðµ/å¤©

- **å¤šåª’ä½“æ–‡ä»¶å­˜å‚¨ç©ºé—´**

é™¤äº†140å­—æ–‡æœ¬å†…å®¹ï¼Œå¾®åšè¿˜å¯ä»¥åŒ…å«å›¾ç‰‡å’Œè§†é¢‘ï¼ŒæŒ‰æ¯5æ¡å¾®åšåŒ…å«ä¸€å¼ å›¾ç‰‡ï¼Œæ¯10æ¡å¾®åšåŒ…å«ä¸€ä¸ªè§†é¢‘ä¼°ç®—ï¼Œæ¯å¼ å›¾ç‰‡500KBï¼Œæ¯ä¸ªè§†é¢‘2MBï¼Œæ¯å¤©è¿˜éœ€è¦60TBçš„å¤šåª’ä½“æ–‡ä»¶å­˜å‚¨ç©ºé—´ã€‚
small2äº¿div5times500KB+2äº¿div10times2MB=60TB/å¤©ð‘ ð‘šð‘Žð‘™ð‘™2äº¿ð‘‘ð‘–ð‘£5ð‘¡ð‘–ð‘šð‘’ð‘ 500ð¾ðµ+2äº¿ð‘‘ð‘–ð‘£10ð‘¡ð‘–ð‘šð‘’ð‘ 2ð‘€ðµ=60ð‘‡ðµ/å¤©
å¯¹äºŽ**åˆ·å¾®åšçš„è®¿é—®å¹¶å‘é‡**ï¼Œæˆ‘ä»¬åšå¦‚ä¸‹ä¼°ç®—ã€‚

- **QPS**

å‡è®¾ä¸¤äº¿æ—¥æ´»ç”¨æˆ·æ¯å¤©æµè§ˆä¸¤æ¬¡å¾®åšï¼Œæ¯æ¬¡å‘ä¸Šæ»‘åŠ¨æˆ–è€…è¿›å…¥æŸä¸ªäººçš„ä¸»é¡µ10æ¬¡ï¼Œæ¯æ¬¡æ˜¾ç¤º20æ¡å¾®åšï¼Œæ¯å¤©åˆ·æ–°å¾®åšæ¬¡æ•°40äº¿æ¬¡ï¼Œå³40äº¿æ¬¡å¾®åšæŸ¥è¯¢æŽ¥å£è°ƒç”¨ï¼Œå¹³å‡QPSå¤§çº¦5ä¸‡ã€‚
small40äº¿divï¼ˆ24times60times60ï¼‰=46296/ç§’ð‘ ð‘šð‘Žð‘™ð‘™40äº¿ð‘‘ð‘–ð‘£ï¼ˆ24ð‘¡ð‘–ð‘šð‘’ð‘ 60ð‘¡ð‘–ð‘šð‘’ð‘ 60ï¼‰=46296/ç§’
é«˜å³°æœŸQPSæŒ‰å¹³å‡å€¼2å€è®¡ç®—ï¼Œæ‰€ä»¥ç³»ç»Ÿéœ€è¦æ»¡è¶³10ä¸‡QPSã€‚

- **ç½‘ç»œå¸¦å®½**

10ä¸‡QPSåˆ·æ–°è¯·æ±‚ï¼Œæ¯æ¬¡è¿”å›žå¾®åš20æ¡ï¼Œé‚£ä¹ˆæ¯ç§’éœ€è®¿é—®200ä¸‡æ¡å¾®åšã€‚æŒ‰æ­¤å‰ä¼°è®¡ï¼Œæ¯5æ¡å¾®åšåŒ…å«ä¸€å¼ å›¾ç‰‡ï¼Œæ¯10æ¡å¾®åšåŒ…å«ä¸€ä¸ªè§†é¢‘ï¼Œéœ€è¦çš„**ç½‘ç»œæ€»å¸¦å®½**ä¸º4.8Tb/sã€‚
smallï¼ˆ200ä¸‡div5times500KB+200ä¸‡div10times2MBï¼‰times8bit=4.8Tb/sð‘ ð‘šð‘Žð‘™ð‘™ï¼ˆ200ä¸‡ð‘‘ð‘–ð‘£5ð‘¡ð‘–ð‘šð‘’ð‘ 500ð¾ðµ+200ä¸‡ð‘‘ð‘–ð‘£10ð‘¡ð‘–ð‘šð‘’ð‘ 2ð‘€ðµï¼‰ð‘¡ð‘–ð‘šð‘’ð‘ 8ð‘ð‘–ð‘¡=4.8ð‘‡ð‘/ð‘ 

### **2 æ¦‚è¦è®¾è®¡**
åœ¨éœ€æ±‚åˆ†æžä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒWeitterçš„ä¸šåŠ¡é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯**å¹¶å‘é‡**å’Œ**æ•°æ®é‡**éƒ½æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ï¼Œ**ç³»ç»Ÿæž¶æž„çš„æ ¸å¿ƒå°±æ˜¯è§£å†³é«˜å¹¶å‘çš„é—®é¢˜**ï¼Œç³»ç»Ÿæ•´ä½“éƒ¨ç½²æ¨¡åž‹å¦‚ä¸‹ã€‚
![1720609069258-db892012-0da1-47ed-94ed-4804e90b8b98.png](./img/TtEZ-MYG9c03xyky/1720609069258-db892012-0da1-47ed-94ed-4804e90b8b98-260371.png)
è¿™é‡ŒåŒ…å«äº†â€œGetè¯·æ±‚â€å’Œâ€œPostè¯·æ±‚â€ä¸¤æ¡é“¾è·¯ï¼ŒGetè¯·æ±‚ä¸»è¦å¤„ç†åˆ·å¾®åšçš„æ“ä½œï¼ŒPostè¯·æ±‚ä¸»è¦å¤„ç†å‘å¾®åšçš„è¯·æ±‚ï¼Œè¿™ä¸¤ç§è¯·æ±‚å¤„ç†ä¹Ÿæœ‰é‡åˆçš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ‹†åˆ†ç€æ¥çœ‹ã€‚
æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹**Getè¯·æ±‚**çš„éƒ¨åˆ†ã€‚
![1720609069330-1e9c03ef-fae3-4718-a382-8c43113046c8.png](./img/TtEZ-MYG9c03xyky/1720609069330-1e9c03ef-fae3-4718-a382-8c43113046c8-594393.png)
ç”¨æˆ·é€šè¿‡CDNè®¿é—®Weitterçš„æ•°æ®ä¸­å¿ƒã€å›¾ç‰‡ä»¥åŠè§†é¢‘ç­‰æžè€—å¸¦å®½çš„è¯·æ±‚ï¼Œç»å¤§éƒ¨åˆ†å¯ä»¥è¢«CDNç¼“å­˜å‘½ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ4.8Tb/sçš„å¸¦å®½åŽ‹åŠ›ï¼Œ90%ä»¥ä¸Šå¯ä»¥é€šè¿‡CDNæ¶ˆåŒ–æŽ‰ã€‚
æ²¡æœ‰è¢«CDNå‘½ä¸­çš„è¯·æ±‚ï¼Œä¸€éƒ¨åˆ†æ˜¯å›¾ç‰‡å’Œè§†é¢‘è¯·æ±‚ï¼Œå…¶ä½™ä¸»è¦æ˜¯ç”¨æˆ·åˆ·æ–°å¾®åšè¯·æ±‚ã€æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯è¯·æ±‚ç­‰ï¼Œè¿™äº›è¯·æ±‚åˆ°è¾¾æ•°æ®ä¸­å¿ƒçš„åå‘ä»£ç†æœåŠ¡å™¨ã€‚åå‘ä»£ç†æœåŠ¡å™¨æ£€æŸ¥æœ¬åœ°ç¼“å­˜æ˜¯å¦æœ‰è¯·æ±‚éœ€è¦çš„å†…å®¹ã€‚å¦‚æžœæœ‰ï¼Œå°±ç›´æŽ¥è¿”å›žï¼›å¦‚æžœæ²¡æœ‰ï¼Œå¯¹äºŽå›¾ç‰‡å’Œè§†é¢‘æ–‡ä»¶ï¼Œä¼šé€šè¿‡åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨é›†ç¾¤èŽ·å–ç›¸å…³å†…å®¹å¹¶è¿”å›žã€‚åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨é›†ç¾¤ä¸­çš„å›¾ç‰‡å’Œè§†é¢‘æ˜¯ç”¨æˆ·å‘è¡¨å¾®åšçš„æ—¶å€™ï¼Œä¸Šä¼ ä¸Šæ¥çš„ã€‚
å¯¹äºŽç”¨æˆ·å¾®åšå†…å®¹ç­‰è¯·æ±‚ï¼Œå¦‚æžœåå‘ä»£ç†æœåŠ¡å™¨æ²¡æœ‰ç¼“å­˜ï¼Œå°±ä¼šé€šè¿‡è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åˆ°è¾¾åº”ç”¨æœåŠ¡å™¨å¤„ç†ã€‚åº”ç”¨æœåŠ¡å™¨é¦–å…ˆä¼šä»ŽRedisç¼“å­˜æœåŠ¡å™¨ä¸­ï¼Œæ£€ç´¢å½“å‰ç”¨æˆ·å…³æ³¨çš„å¥½å‹å‘è¡¨çš„æœ€æ–°å¾®åšï¼Œå¹¶æž„å»ºä¸€ä¸ªç»“æžœé¡µé¢è¿”å›žã€‚å¦‚æžœRedisä¸­ç¼“å­˜çš„å¾®åšæ•°æ®é‡ä¸è¶³ï¼Œæž„é€ ä¸å‡ºä¸€ä¸ªç»“æžœé¡µé¢éœ€è¦çš„20æ¡å¾®åšï¼Œåº”ç”¨æœåŠ¡å™¨ä¼šç»§ç»­ä»ŽMySQLåˆ†ç‰‡æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®ã€‚
ä»¥ä¸Šå¤„ç†æµç¨‹ä¸»è¦æ˜¯é’ˆå¯¹è¯»ï¼ˆhttp getï¼‰è¯·æ±‚ï¼Œé‚£å¦‚æžœæ˜¯å‘è¡¨å¾®åšè¿™æ ·çš„å†™ï¼ˆhttp postï¼‰è¯·æ±‚å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹**å†™è¯·æ±‚**éƒ¨åˆ†çš„å›¾ã€‚
![1720609069305-4707bb00-dad1-4d3f-9545-9506bcbbe041.png](./img/TtEZ-MYG9c03xyky/1720609069305-4707bb00-dad1-4d3f-9545-9506bcbbe041-844197.png)
ä½ ä¼šçœ‹åˆ°ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦é€šè¿‡CDNå’Œåå‘ä»£ç†ï¼Œè€Œæ˜¯ç›´æŽ¥é€šè¿‡è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åˆ°è¾¾åº”ç”¨æœåŠ¡å™¨ã€‚åº”ç”¨æœåŠ¡å™¨ä¸€æ–¹é¢ä¼šå°†å‘è¡¨çš„å¾®åšå†™å…¥Redisç¼“å­˜é›†ç¾¤ï¼Œä¸€æ–¹é¢å†™å…¥åˆ†ç‰‡æ•°æ®åº“ä¸­ã€‚
åœ¨å†™å…¥æ•°æ®åº“çš„æ—¶å€™ï¼Œå¦‚æžœç›´æŽ¥å†™æ•°æ®åº“ï¼Œå½“æœ‰é«˜å¹¶å‘çš„å†™è¯·æ±‚çªç„¶åˆ°æ¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“è¿‡è½½ï¼Œè¿›è€Œå¼•å‘ç³»ç»Ÿå´©æºƒã€‚æ‰€ä»¥ï¼Œæ•°æ®åº“å†™æ“ä½œï¼ŒåŒ…æ‹¬å‘è¡¨å¾®åšã€å…³æ³¨å¥½å‹ã€è¯„è®ºå¾®åšç­‰ï¼Œéƒ½å†™å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨ï¼Œç”±æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ç¨‹åºä»Žæ¶ˆæ¯é˜Ÿåˆ—ä¸­æŒ‰ç…§ä¸€å®šçš„é€Ÿåº¦æ¶ˆè´¹æ¶ˆæ¯ï¼Œå¹¶å†™å…¥æ•°æ®åº“ä¸­ï¼Œä¿è¯æ•°æ®åº“çš„è´Ÿè½½åŽ‹åŠ›ä¸ä¼šçªç„¶å¢žåŠ ã€‚

### **3 è¯¦ç»†è®¾è®¡**
ç”¨æˆ·åˆ·æ–°å¾®åšçš„æ—¶å€™ï¼Œå¦‚ä½•èƒ½å¿«é€Ÿå¾—åˆ°è‡ªå·±å…³æ³¨çš„å¥½å‹çš„æœ€æ–°å¾®åšåˆ—è¡¨ï¼Ÿ10ä¸‡QPSçš„å¹¶å‘é‡å¦‚ä½•åº”å¯¹ï¼Ÿå¦‚ä½•é¿å…æ•°æ®åº“è´Ÿè½½åŽ‹åŠ›å¤ªå¤§ä»¥åŠå¦‚ä½•å¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚ï¼Ÿè¯¦ç»†è®¾è®¡å°†åŸºäºŽåŠŸèƒ½éœ€æ±‚å’Œæ¦‚è¦è®¾è®¡ï¼Œä¸»è¦è®¨è®ºè¿™äº›é—®é¢˜ã€‚

#### **3.1 å¾®åšçš„å‘è¡¨/è®¢é˜…é—®é¢˜**
Weitterç”¨æˆ·å…³æ³¨å¥½å‹åŽï¼Œå¦‚ä½•å¿«é€Ÿå¾—åˆ°æ‰€æœ‰å¥½å‹çš„æœ€æ–°å‘è¡¨çš„å¾®åšå†…å®¹ï¼Œå³å‘è¡¨/è®¢é˜…é—®é¢˜ï¼Œæ˜¯å¾®åšçš„æ ¸å¿ƒä¸šåŠ¡é—®é¢˜ã€‚
ä¸€ç§ç®€å•çš„åŠžæ³•å°±æ˜¯â€œæŽ¨æ¨¡å¼â€ï¼Œå³å»ºä¸€å¼ ç”¨æˆ·è®¢é˜…è¡¨ï¼Œç”¨æˆ·å…³æ³¨çš„å¥½å‹å‘è¡¨å¾®åšåŽï¼Œç«‹å³åœ¨ç”¨æˆ·è®¢é˜…ä¸­ä¸ºè¯¥ç”¨æˆ·æ’å…¥ä¸€æ¡è®°å½•ï¼Œè®°å½•ç”¨æˆ·idå’Œå¥½å‹å‘è¡¨çš„å¾®åšidã€‚è¿™æ ·å½“ç”¨æˆ·åˆ·æ–°å¾®åšçš„æ—¶å€™ï¼Œåªéœ€è¦ä»Žç”¨æˆ·è®¢é˜…è¡¨ä¸­æŒ‰ç”¨æˆ·idæŸ¥è¯¢æ‰€æœ‰è®¢é˜…çš„å¾®åšï¼Œç„¶åŽæŒ‰æ—¶é—´é¡ºåºæž„å»ºä¸€ä¸ªåˆ—è¡¨å³å¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**æŽ¨æ¨¡å¼æ˜¯åœ¨ç”¨æˆ·å‘**å¾®åš**çš„æ—¶å€™æŽ¨é€ç»™æ‰€æœ‰çš„å…³æ³¨è€…**ï¼Œå¦‚ä¸‹å›¾ï¼Œç”¨æˆ·å‘è¡¨äº†å¾®åš0ï¼Œä»–çš„æ‰€æœ‰å…³æ³¨è€…çš„è®¢é˜…è¡¨éƒ½æ’å…¥å¾®åš0ã€‚
![1720609069217-ba21ec53-abad-4034-9668-ab29946a2a80.png](./img/TtEZ-MYG9c03xyky/1720609069217-ba21ec53-abad-4034-9668-ab29946a2a80-050951.png)
æŽ¨æ¨¡å¼å®žçŽ°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æŽ¨æ¨¡å¼æ„å‘³ç€ï¼Œå¦‚æžœä¸€ä¸ªç”¨æˆ·æœ‰å¤§é‡çš„å…³æ³¨è€…ï¼Œé‚£ä¹ˆè¯¥ç”¨æˆ·æ¯å‘è¡¨ä¸€æ¡å¾®åšï¼Œå°±éœ€è¦åœ¨è®¢é˜…è¡¨ä¸­ä¸ºæ¯ä¸ªå…³æ³¨è€…æ’å…¥ä¸€æ¡è®°å½•ã€‚è€Œå¯¹äºŽæ˜Žæ˜Ÿç”¨æˆ·è€Œè¨€ï¼Œå¯èƒ½ä¼šæœ‰å‡ åƒä¸‡çš„å…³æ³¨è€…ï¼Œæ˜Žæ˜Ÿç”¨æˆ·å‘è¡¨ä¸€æ¡å¾®åšï¼Œå°±ä¼šå¯¼è‡´ä¸Šåƒä¸‡æ¬¡çš„æ•°æ®åº“æ’å…¥æ“ä½œï¼Œç›´æŽ¥å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚
æ‰€ä»¥ï¼Œå¯¹äºŽ10äº¿çº§ç”¨æˆ·çš„å¾®åšç³»ç»Ÿè€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨â€œæ‹‰æ¨¡å¼â€è§£å†³å‘è¡¨/è®¢é˜…é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·åˆ·æ–°å¾®åšçš„æ—¶å€™ï¼Œæ ¹æ®å…¶å…³æ³¨çš„å¥½å‹åˆ—è¡¨ï¼ŒæŸ¥è¯¢æ¯ä¸ªå¥½å‹è¿‘æœŸå‘è¡¨çš„å¾®åšï¼Œç„¶åŽå°†æ‰€æœ‰å¾®åšæŒ‰ç…§æ—¶é—´é¡ºåºæŽ’åºåŽæž„å»ºä¸€ä¸ªåˆ—è¡¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**æ‹‰æ¨¡å¼æ˜¯åœ¨ç”¨æˆ·åˆ·å¾®åšçš„æ—¶å€™æ‹‰å–ä»–å…³æ³¨çš„æ‰€æœ‰å¥½å‹çš„æœ€æ–°å¾®åš**ï¼Œå¦‚ä¸‹å›¾ï¼š
![1720609069983-eef088a4-35e1-49af-b3da-6319b3a8c914.png](./img/TtEZ-MYG9c03xyky/1720609069983-eef088a4-35e1-49af-b3da-6319b3a8c914-159866.png)
æ‹‰æ¨¡å¼æžå¤§é™ä½Žäº†å‘è¡¨å¾®åšæ—¶å†™å…¥æ•°æ®çš„è´Ÿè½½åŽ‹åŠ›ï¼Œä½†æ˜¯å´åˆæ€¥å‰§å¢žåŠ äº†åˆ·å¾®åšæ—¶å€™è¯»æ•°æ®åº“çš„åŽ‹åŠ›ã€‚å› ä¸ºå¯¹äºŽç”¨æˆ·å…³æ³¨çš„æ¯ä¸ªå¥½å‹ï¼Œéƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢ã€‚å¦‚æžœä¸€ä¸ªç”¨æˆ·å…³æ³¨äº†å¤§é‡å¥½å‹ï¼ŒæŸ¥è¯¢åŽ‹åŠ›ä¹Ÿæ˜¯éžå¸¸å·¨å¤§çš„ã€‚
æ‰€ä»¥ï¼Œé¦–å…ˆéœ€è¦é™åˆ¶ç”¨æˆ·å…³æ³¨çš„å¥½å‹æ•°ï¼Œåœ¨Weitterä¸­ï¼Œæ™®é€šç”¨æˆ·å…³æ³¨ä¸Šé™æ˜¯2000äººï¼ŒVIPç”¨æˆ·å…³æ³¨ä¸Šé™æ˜¯5000äººã€‚å…¶æ¬¡ï¼Œéœ€è¦å°½é‡å‡å°‘åˆ·æ–°æ—¶æŸ¥è¯¢æ•°æ®åº“çš„æ¬¡æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¾®åšè¦å°½é‡é€šè¿‡ç¼“å­˜è¯»å–ã€‚
ä½†å³ä½¿å¦‚æ­¤ï¼Œä½ ä¼šå‘çŽ°æ¯æ¬¡åˆ·æ–°çš„æŸ¥è¯¢åŽ‹åŠ›è¿˜æ˜¯å¤ªå¤§ï¼Œæ‰€ä»¥Weitteræœ€ç»ˆé‡‡ç”¨â€œæŽ¨æ‹‰ç»“åˆâ€çš„æ¨¡å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æžœç”¨æˆ·å½“å‰åœ¨çº¿ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨æŽ¨æ¨¡å¼ï¼Œç³»ç»Ÿä¼šåœ¨ç¼“å­˜ä¸­ä¸ºå…¶åˆ›å»ºä¸€ä¸ªå¥½å‹æœ€æ–°å‘è¡¨å¾®åšåˆ—è¡¨ï¼Œå…³æ³¨çš„å¥½å‹å¦‚æžœæœ‰æ–°å‘è¡¨å¾®åšï¼Œå°±ç«‹å³å°†è¯¥å¾®åšæ’å…¥åˆ—è¡¨çš„å¤´éƒ¨ï¼Œå½“è¯¥ç”¨æˆ·åˆ·æ–°å¾®åšçš„æ—¶å€™ï¼Œåªéœ€è¦å°†è¿™ä¸ªåˆ—è¡¨è¿”å›žå³å¯ã€‚
å¦‚æžœç”¨æˆ·å½“å‰ä¸åœ¨çº¿ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šå°†è¯¥åˆ—è¡¨åˆ é™¤ã€‚å½“ç”¨æˆ·ç™»å½•åˆ·æ–°çš„æ—¶å€™ï¼Œç”¨æ‹‰æ¨¡å¼ä¸ºå…¶é‡æ–°æž„å»ºåˆ—è¡¨ã€‚
é‚£ä¹ˆå¦‚ä½•ç¡®å®šä¸€ä¸ªç”¨æˆ·æ˜¯å¦åœ¨çº¿ï¼Ÿä¸€æ–¹é¢å¯ä»¥é€šè¿‡ç”¨æˆ·æ“ä½œæ—¶é—´é—´éš”æ¥åˆ¤æ–­ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¯ä»¥é€šè¿‡æœºå™¨å­¦ä¹ ï¼Œé¢„æµ‹ç”¨æˆ·çš„ä¸Šçº¿æ—¶é—´ï¼Œåˆ©ç”¨ç³»ç»Ÿç©ºé—²æ—¶é—´ï¼Œæå‰ä¸ºå…¶æž„å»ºæœ€æ–°å¾®åšåˆ—è¡¨ã€‚

#### **3.2 ç¼“å­˜ä½¿ç”¨ç­–ç•¥**
é€šè¿‡å‰é¢çš„åˆ†æžæˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼ŒWeitteræ˜¯ä¸€ä¸ªå…¸åž‹çš„é«˜å¹¶å‘è¯»æ“ä½œçš„åœºæ™¯ã€‚10ä¸‡QPSåˆ·æ–°è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚éœ€è¦è¿”å›ž20æ¡å¾®åšï¼Œå¦‚æžœå…¨éƒ¨åˆ°æ•°æ®åº“ä¸­æŸ¥è¯¢çš„è¯ï¼Œæ•°æ®åº“çš„QPSå°†è¾¾åˆ°200ä¸‡ï¼Œå³ä½¿æ˜¯ä½¿ç”¨åˆ†ç‰‡çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œè¿™ç§åŽ‹åŠ›ä¹Ÿä¾ç„¶æ˜¯æ— æ³•æ‰¿å—çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å¤§é‡ä½¿ç”¨ç¼“å­˜ä»¥æ”¹å–„æ€§èƒ½ï¼Œæé«˜åžåèƒ½åŠ›ã€‚
ä½†æ˜¯ç¼“å­˜çš„ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œæˆ‘ä»¬å¿…å®šä¸èƒ½å°†æ‰€æœ‰æ•°æ®éƒ½ç¼“å­˜èµ·æ¥ã€‚ä¸€èˆ¬ç¼“å­˜ä½¿ç”¨çš„æ˜¯LRUæ·˜æ±°ç®—æ³•ï¼Œå³å½“ç¼“å­˜ç©ºé—´ä¸è¶³æ—¶ï¼Œå°†æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜æ•°æ®åˆ é™¤ï¼Œç©ºå‡ºç¼“å­˜ç©ºé—´å­˜å‚¨æ–°æ•°æ®ã€‚
ä½†æ˜¯LRUç®—æ³•å¹¶ä¸é€‚åˆå¾®åšçš„åœºæ™¯ï¼Œå› ä¸ºåœ¨æ‹‰æ¨¡å¼çš„æƒ…å†µä¸‹ï¼Œå½“ç”¨æˆ·åˆ·æ–°å¾®åšçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿å…¶å…³æ³¨çš„å¥½å‹æœ€æ–°å‘è¡¨çš„å¾®åšéƒ½èƒ½å±•ç¤ºå‡ºæ¥ï¼Œå¦‚æžœå…¶å…³æ³¨çš„æŸä¸ªå¥½å‹è¾ƒå°‘æœ‰å…¶ä»–å…³æ³¨è€…ï¼Œé‚£ä¹ˆè¿™ä¸ªå¥½å‹å‘è¡¨çš„å¾®åšå°±å¾ˆå¯èƒ½ä¼šè¢«LRUç®—æ³•æ·˜æ±°åˆ é™¤å‡ºç¼“å­˜ã€‚å¯¹äºŽè¿™ç§æƒ…å†µï¼Œç³»ç»Ÿå°±ä¸å¾—ä¸åŽ»æ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚
è€Œæœ€å…³é”®çš„æ˜¯ï¼Œç³»ç»Ÿå¹¶ä¸èƒ½çŸ¥é“å“ªäº›å¥½å‹çš„æ•°æ®é€šè¿‡è¯»ç¼“å­˜å°±å¯ä»¥å¾—åˆ°å…¨éƒ¨æœ€æ–°çš„å¾®åšï¼Œè€Œå“ªäº›å¥½å‹éœ€è¦åˆ°æ•°æ®åº“ä¸­æŸ¥æ‰¾ã€‚å› æ­¤ä¸å¾—ä¸å…¨éƒ¨åˆ°æ•°æ®åº“ä¸­æŸ¥æ‰¾ï¼Œè¿™å°±å¤±åŽ»äº†ä½¿ç”¨ç¼“å­˜çš„æ„ä¹‰ã€‚
åŸºäºŽæ­¤ï¼Œæˆ‘ä»¬åœ¨Weitterä¸­ä½¿ç”¨**æ—¶é—´æ·˜æ±°ç®—æ³•**ï¼Œ**ä¹Ÿå°±æ˜¯å°†æœ€è¿‘ä¸€å®šå¤©æ•°å†…å‘å¸ƒçš„å¾®åšå…¨éƒ¨ç¼“å­˜èµ·æ¥ï¼Œç”¨æˆ·åˆ·æ–°å¾®åšçš„æ—¶å€™ï¼Œåªéœ€è¦åœ¨ç¼“å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚å¦‚æžœæŸ¥æ‰¾åˆ°çš„å¾®åšæ•°æ»¡è¶³ä¸€æ¬¡è¿”å›žçš„æ¡æ•°ï¼ˆ20æ¡ï¼‰ï¼Œå°±ç›´æŽ¥è¿”å›žç»™ç”¨æˆ·ï¼›å¦‚æžœç¼“å­˜ä¸­çš„å¾®åšæ•°ä¸è¶³ï¼Œå°±å†åˆ°æ•°æ®åº“ä¸­æŸ¥æ‰¾ã€‚
æœ€ç»ˆï¼ŒWeitterå†³å®šç¼“å­˜7å¤©å†…å‘è¡¨çš„å…¨éƒ¨å¾®åšï¼Œéœ€è¦çš„ç¼“å­˜ç©ºé—´çº¦700Gã€‚ç¼“å­˜çš„keyä¸ºç”¨æˆ·IDï¼Œvalueä¸ºç”¨æˆ·æœ€è¿‘7å¤©å‘è¡¨çš„å¾®åšIDåˆ—è¡¨ã€‚è€Œå¾®åšIDå’Œå¾®åšå†…å®¹åˆ†åˆ«ä½œä¸ºkeyå’Œvalueä¹Ÿç¼“å­˜èµ·æ¥ã€‚
æ­¤å¤–ï¼Œå¯¹äºŽç‰¹åˆ«çƒ­é—¨çš„å¾®åšå†…å®¹ï¼Œæ¯”å¦‚æŸä¸ªæ˜Žæ˜Ÿçš„ç¦»å©šå¾®åšï¼Œè¿™ç§é’ˆå¯¹å•ä¸ªå¾®åšå†…å®¹çš„é«˜å¹¶å‘è®¿é—®ï¼Œç”±äºŽè®¿é—®åŽ‹åŠ›éƒ½é›†ä¸­ä¸€ä¸ªç¼“å­˜keyä¸Šï¼Œä¼šç»™å•å°RedisæœåŠ¡å™¨é€ æˆæžå¤§çš„è´Ÿè½½åŽ‹åŠ›ã€‚å› æ­¤ï¼Œå¾®åšè¿˜ä¼šå¯ç”¨**æœ¬åœ°ç¼“å­˜æ¨¡å¼**ï¼Œå³åº”ç”¨æœåŠ¡å™¨åœ¨å†…å­˜ä¸­ç¼“å­˜ç‰¹åˆ«çƒ­é—¨çš„å¾®åšå†…å®¹ï¼Œåº”ç”¨æž„å»ºå¾®åšåˆ·æ–°é¡µçš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆæ£€æŸ¥å¾®åšIDå¯¹åº”çš„å¾®åšå†…å®¹æ˜¯å¦åœ¨æœ¬åœ°ç¼“å­˜ä¸­ã€‚
Weitteræœ€åŽç¡®å®šçš„æœ¬åœ°ç¼“å­˜ç­–ç•¥æ˜¯ï¼šé’ˆå¯¹æ‹¥æœ‰100ä¸‡ä»¥ä¸Šå…³æ³¨è€…çš„å¤§Vç”¨æˆ·ï¼Œç¼“å­˜å…¶48å°æ—¶å†…å‘è¡¨çš„å…¨éƒ¨å¾®åšã€‚
çŽ°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Weitteræ•´ä½“çš„ç¼“å­˜æž¶æž„ã€‚
![1720609069890-9915e08c-4d47-4632-a234-b98c418aef3e.png](./img/TtEZ-MYG9c03xyky/1720609069890-9915e08c-4d47-4632-a234-b98c418aef3e-133693.png)

#### **3.3 æ•°æ®åº“åˆ†ç‰‡ç­–ç•¥**
å‰é¢æˆ‘ä»¬åˆ†æžè¿‡ï¼ŒWeitteræ¯å¤©æ–°å¢ž2äº¿æ¡å¾®åšã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹³å‡æ¯ç§’é’Ÿéœ€è¦å†™å…¥2400æ¡å¾®åšï¼Œé«˜å³°æœŸæ¯ç§’å†™å…¥4600æ¡å¾®åšã€‚è¿™æ ·çš„å†™å…¥åŽ‹åŠ›ï¼Œå¯¹äºŽå•æœºæ•°æ®åº“è€Œè¨€æ˜¯æ— æ³•æ‰¿å—çš„ã€‚è€Œä¸”ï¼Œæ¯å¹´æ–°å¢ž700äº¿æ¡å¾®åšè®°å½•ï¼Œè¿™ä¹Ÿè¶…å‡ºäº†å•æœºæ•°æ®åº“çš„å­˜å‚¨èƒ½åŠ›ã€‚å› æ­¤ï¼ŒWeitterçš„æ•°æ®åº“éœ€è¦é‡‡ç”¨åˆ†ç‰‡éƒ¨ç½²çš„åˆ†å¸ƒå¼æ•°æ®åº“ã€‚åˆ†ç‰‡çš„è§„åˆ™å¯ä»¥é‡‡ç”¨ç”¨æˆ·IDåˆ†ç‰‡æˆ–è€…å¾®åš IDåˆ†ç‰‡ã€‚
å¦‚æžœæŒ‰ç”¨æˆ·IDï¼ˆçš„hashå€¼ï¼‰åˆ†ç‰‡ï¼Œé‚£ä¹ˆä¸€ä¸ªç”¨æˆ·å‘è¡¨çš„å…¨éƒ¨å¾®åšéƒ½ä¼šä¿å­˜åˆ°ä¸€å°æ•°æ®åº“æœåŠ¡å™¨ä¸Šã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå½“ç³»ç»Ÿéœ€è¦æŒ‰ç”¨æˆ·æŸ¥æ‰¾å…¶å‘è¡¨çš„å¾®åšçš„æ—¶å€™ï¼Œåªéœ€è¦è®¿é—®ä¸€å°æœåŠ¡å™¨å°±å¯ä»¥å®Œæˆã€‚
ä½†æ˜¯è¿™æ ·åšä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå¯¹äºŽä¸€ä¸ªæ˜Žæ˜Ÿå¤§Vç”¨æˆ·ï¼Œå…¶æ•°æ®è®¿é—®ä¼šæˆçƒ­ç‚¹ï¼Œè¿›è€Œå¯¼è‡´è¿™å°æœåŠ¡å™¨è´Ÿè½½åŽ‹åŠ›å¤ªå¤§ã€‚åŒæ ·åœ°ï¼Œå¦‚æžœæŸä¸ªç”¨æˆ·é¢‘ç¹å‘è¡¨å¾®åšï¼Œä¹Ÿä¼šå¯¼è‡´è¿™å°æœåŠ¡å™¨æ•°æ®å¢žé•¿è¿‡å¿«ã€‚
è¦æ˜¯æŒ‰å¾®åš IDï¼ˆçš„hashå€¼ï¼‰åˆ†ç‰‡ï¼Œè™½ç„¶å¯ä»¥é¿å…ä¸Šè¿°æŒ‰ç”¨æˆ·IDåˆ†ç‰‡çš„çƒ­ç‚¹èšé›†é—®é¢˜ï¼Œä½†æ˜¯å½“æŸ¥æ‰¾ä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰å¾®åšæ—¶ï¼Œéœ€è¦è®¿é—®æ‰€æœ‰çš„åˆ†ç‰‡æ•°æ®åº“æœåŠ¡å™¨æ‰èƒ½å¾—åˆ°æ‰€éœ€çš„æ•°æ®ï¼Œå¯¹æ•°æ®åº“æœåŠ¡å™¨é›†ç¾¤çš„æ•´ä½“åŽ‹åŠ›å¤ªå¤§ã€‚
ç»¼åˆè€ƒè™‘ï¼Œç”¨æˆ·IDåˆ†ç‰‡å¸¦æ¥çš„çƒ­ç‚¹é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä¼˜åŒ–ç¼“å­˜æ¥æ”¹å–„ï¼›è€ŒæŸä¸ªç”¨æˆ·é¢‘ç¹å‘è¡¨å¾®åšçš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®æ¯å¤©å‘è¡¨å¾®åšæ•°ä¸Šé™ï¼ˆæ¯ä¸ªç”¨æˆ·æ¯å¤©æœ€å¤šå‘è¡¨50æ¡å¾®åšï¼‰æ¥è§£å†³ã€‚æœ€ç»ˆï¼ŒWeitteré‡‡ç”¨æŒ‰ç”¨æˆ·IDåˆ†ç‰‡çš„ç­–ç•¥ã€‚

## å¦‚ä½•é¿å…è¶…é¢„æœŸçš„é«˜å¹¶å‘åŽ‹åŠ›åŽ‹åž®ç³»ç»Ÿï¼Ÿ
åœ¨äº’è”ç½‘é«˜å¯ç”¨æž¶æž„è®¾è®¡ä¸­ï¼Œé™æµæ˜¯ä¸€ç§ç»å…¸çš„é«˜å¯ç”¨æž¶æž„æ¨¡å¼ã€‚å› ä¸ºæŸäº›åŽŸå› ï¼Œå¤§é‡ç”¨æˆ·çªç„¶è®¿é—®æˆ‘ä»¬çš„ç³»ç»Ÿæ—¶ï¼Œæˆ–è€…æœ‰é»‘å®¢æ¶æ„ç”¨DoSï¼ˆDenial of Serviceï¼Œæ‹’ç»æœåŠ¡ï¼‰æ–¹å¼æ”»å‡»æˆ‘ä»¬çš„ç³»ç»Ÿæ—¶ï¼Œè¿™ç§æœªæ›¾é¢„æœŸçš„é«˜å¹¶å‘è®¿é—®å¯¹ç³»ç»Ÿäº§ç”Ÿçš„è´Ÿè½½åŽ‹åŠ›å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚
è§£å†³è¿™ç§é—®é¢˜çš„ä¸€ä¸ªä¸»è¦æ‰‹æ®µå°±æ˜¯é™æµï¼Œå³æ‹’ç»éƒ¨åˆ†è®¿é—®è¯·æ±‚ï¼Œä½¿è®¿é—®è´Ÿè½½åŽ‹åŠ›é™ä½Žåˆ°ä¸€ä¸ªç³»ç»Ÿå¯ä»¥æ‰¿å—çš„ç¨‹åº¦ã€‚è¿™æ ·è™½ç„¶æœ‰éƒ¨åˆ†ç”¨æˆ·è®¿é—®å¤±è´¥ï¼Œä½†æ˜¯æ•´ä¸ªç³»ç»Ÿä¾ç„¶æ˜¯å¯ç”¨çš„ï¼Œä¾ç„¶èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œè€Œä¸æ˜¯å› ä¸ºè´Ÿè½½åŽ‹åŠ›å¤ªå¤§è€Œå´©æºƒï¼Œå¯¼è‡´æ‰€æœ‰ç”¨æˆ·éƒ½ä¸èƒ½è®¿é—®ã€‚
ä¸ºæ­¤ï¼Œæˆ‘ä»¬å‡†å¤‡å¼€å‘ä¸€ä¸ªé™æµå™¨ï¼Œäº§å“åç§°ä¸ºâ€œDianaâ€ã€‚

### **14.1 éœ€æ±‚åˆ†æž**
æˆ‘ä»¬å°†Dianaå®šä½ä¸ºä¸€ä¸ªé™æµå™¨ç»„ä»¶ï¼Œå³Dianaçš„ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯éƒ¨ç½²åœ¨å¾®æœåŠ¡ç½‘å…³æˆ–è€…å…¶ä»–HTTPæœåŠ¡å™¨å…¥å£ï¼Œä»¥è¿‡æ»¤å™¨çš„æ–¹å¼å¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œå¯¹è¶…è¿‡é™æµè§„åˆ™çš„è¯·æ±‚è¿”å›žâ€œæœåŠ¡ä¸å¯ç”¨â€HTTPå“åº”ã€‚
Dianaçš„é™æµè§„åˆ™å¯é€šè¿‡é…ç½®æ–‡ä»¶èŽ·å–ï¼Œå¹¶éœ€è¦æ”¯æŒæœ¬åœ°é…ç½®å’Œè¿œç¨‹é…ç½®ä¸¤ç§æ–¹å¼ï¼Œè¿œç¨‹é…ç½®ä¼˜å…ˆäºŽæœ¬åœ°é…ç½®ã€‚é™æµæ–¹å¼åŒ…æ‹¬ï¼š

- å…¨å±€é™æµï¼šé’ˆå¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œé™æµï¼Œå³ä¿è¯æ•´ä¸ªç³»ç»Ÿå¤„ç†çš„è¯·æ±‚æ€»æ•°æ»¡è¶³é™æµé…ç½®ã€‚
- è´¦å·é™æµï¼šé’ˆå¯¹è´¦å·è¿›è¡Œé™æµï¼Œå³å¯¹å•ä¸ªè´¦å·å‘é€çš„è¯·æ±‚è¿›è¡Œé™æµã€‚
- è®¾å¤‡é™æµï¼šé’ˆå¯¹è®¾å¤‡è¿›è¡Œé™æµï¼Œå³å¯¹å•ä¸ªå®¢æˆ·ç«¯è®¾å¤‡å‘é€çš„è¯·æ±‚è¿›è¡Œé™æµã€‚
- èµ„æºé™æµï¼šé’ˆå¯¹æŸä¸ªèµ„æºï¼ˆå³æŸä¸ªURLï¼‰è¿›è¡Œé™æµï¼Œå³ä¿è¯è®¿é—®è¯¥èµ„æºçš„è¯·æ±‚æ€»æ•°æ»¡è¶³é™æµé…ç½®ã€‚

å¹¶ä¸”Dianaè®¾è®¡åº”éµå¾ªå¼€é—­åŽŸåˆ™ï¼Œèƒ½å¤Ÿæ”¯æŒçµæ´»çš„é™æµè§„åˆ™åŠŸèƒ½æ‰©å±•ï¼Œå³æœªæ¥åœ¨ä¸ä¿®æ”¹çŽ°æœ‰ä»£ç å’Œå…¼å®¹çŽ°æœ‰é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œæ”¯æŒæ–°çš„é…ç½®è§„åˆ™ã€‚

### **14.2 æ¦‚è¦è®¾è®¡**
Dianaçš„è®¾è®¡ç›®æ ‡æ˜¯ä¸€ä¸ªé™æµå™¨ç»„ä»¶ï¼Œå³Dianaå¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿï¼Œä¸å¯ä»¥ç‹¬ç«‹éƒ¨ç½²è¿›è¡Œé™æµï¼Œè€Œæ˜¯éƒ¨ç½²åœ¨ç³»ç»Ÿç½‘å…³ï¼ˆæˆ–è€…å…¶ä»–HTTPæœåŠ¡å™¨ä¸Šï¼‰ï¼Œä½œä¸ºç½‘å…³çš„ä¸€ä¸ªç»„ä»¶è¿›è¡Œé™æµï¼Œéƒ¨ç½²æ¨¡åž‹å¦‚ä¸‹ï¼š
![1720609069903-f52a7619-7b79-4949-b73b-afb7566ea3bb.jpeg](./img/TtEZ-MYG9c03xyky/1720609069903-f52a7619-7b79-4949-b73b-afb7566ea3bb-793775.jpeg)
ç”¨æˆ·è¯·æ±‚ï¼ˆé€šè¿‡è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼‰åˆ°è¾¾ç½‘å…³æœåŠ¡å™¨ã€‚ç½‘å…³æœåŠ¡å™¨æœ¬è´¨ä¹Ÿæ˜¯ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œé™æµå™¨æ˜¯éƒ¨ç½²åœ¨ç½‘å…³ä¸­çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ˆfilterï¼‰ç»„ä»¶ï¼Œå’Œç½‘å…³ä¸­çš„ç­¾åæ ¡éªŒè¿‡æ»¤å™¨ã€ç”¨æˆ·æƒé™è¿‡æ»¤å™¨ç­‰é…ç½®åœ¨åŒä¸€ä¸ªè¿‡æ»¤å™¨è´£ä»»é“¾ï¼ˆChain of Responsibilityï¼‰ä¸Šã€‚é™æµå™¨åº”è¯¥é…ç½®åœ¨æ•´ä¸ªè¿‡æ»¤å™¨è´£ä»»é“¾çš„å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æžœè¯·æ±‚è¶…è¿‡äº†é™æµï¼Œè¯·æ±‚ä¸éœ€è¦å†è¿›å…¥å…¶ä»–è¿‡æ»¤å™¨ï¼Œç›´æŽ¥è¢«é™æµå™¨æ‹’ç»ã€‚
ç”¨æˆ·è¯·æ±‚è¿›å…¥é™æµå™¨åŽï¼Œæ ¹æ®é™æµç­–ç•¥ï¼Œåˆ¤æ–­è¯¥è¯·æ±‚æ˜¯å¦å·²ç»è¶…è¿‡é™æµï¼Œå¦‚æžœè¶…è¿‡ï¼Œé™æµå™¨ç›´æŽ¥è¿”å›žçŠ¶æ€ç ä¸º503ï¼ˆToo Many Requestsï¼‰çš„å“åº”ï¼›å¦‚æžœæ²¡æœ‰è¶…è¿‡é™æµï¼Œè¯·æ±‚ç»§ç»­å‘ä¸‹å¤„ç†ï¼ˆç»è¿‡å…¶ä»–ç½‘å…³è¿‡æ»¤å™¨ï¼‰ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨å¾®æœåŠ¡å®Œæˆå¤„ç†ã€‚
é™æµå™¨çš„ç­–ç•¥å¯ä»¥åœ¨æœ¬åœ°é…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿œç¨‹çš„é…ç½®ä¸­å¿ƒæœåŠ¡å™¨åŠ è½½ï¼Œå³è¿œç¨‹é…ç½®ã€‚è¿œç¨‹é…ç½®ä¼˜å…ˆäºŽæœ¬åœ°é…ç½®ã€‚

#### **14.2.1 é™æµæ¨¡å¼è®¾è®¡**
è¯·æ±‚æ˜¯å¦è¶…è¿‡é™æµï¼Œä¸»è¦å°±æ˜¯åˆ¤æ–­å•ä½æ—¶é—´è¯·æ±‚æ•°é‡æ˜¯å¦è¶…è¿‡é…ç½®çš„è¯·æ±‚é™æµæ•°é‡ã€‚å•ä½æ—¶é—´è¯·æ±‚æ•°é‡ï¼Œå¯ä»¥æœ¬åœ°è®°å½•ï¼Œä¹Ÿå¯ä»¥è¿œç¨‹è®°å½•ã€‚æ–¹ä¾¿èµ·è§ï¼Œæœ¬åœ°è®°å½•ç§°ä½œæœ¬åœ°é™æµï¼Œè¿œç¨‹è®°å½•ç§°ä½œè¿œç¨‹é™æµï¼ˆä¹Ÿå«åˆ†å¸ƒå¼é™æµï¼‰ã€‚
æœ¬åœ°é™æµæ„å‘³ç€ï¼Œæ¯ä¸ªç½‘å…³æœåŠ¡å™¨éœ€è¦æ ¹æ®æœ¬åœ°è®°å½•çš„å•ä½æ—¶é—´è¯·æ±‚æ•°é‡è¿›è¡Œé™æµã€‚å‡è®¾é™æµé…ç½®ä¸ºæ¯ç§’é™æµ50è¯·æ±‚ï¼Œå¦‚æžœè¯¥ç½‘å…³æœåŠ¡å™¨æœ¬åœ°è®°å½•çš„å½“å‰ä¸€ç§’å†…æŽ¥å—è¯·æ±‚æ•°é‡è¾¾åˆ°50ï¼Œé‚£ä¹ˆè¿™ä¸€ç§’å†…çš„åŽç»­è¯·æ±‚éƒ½è¿”å›ž503å“åº”ã€‚å¦‚æžœæ•´ä¸ªç³»ç»Ÿéƒ¨ç½²äº†100å°ç½‘å…³æœåŠ¡å™¨ï¼Œæ¯ä¸ªç½‘å…³é…ç½®æœ¬åœ°é™æµä¸ºæ¯ç§’50ï¼Œé‚£ä¹ˆï¼Œæ•´ä¸ªç³»ç»Ÿæ¯ç§’æœ€å¤šå¯ä»¥å¤„ç†5000ä¸ªè¯·æ±‚ã€‚
è¿œç¨‹é™æµæ„å‘³ç€ï¼Œæ‰€æœ‰ç½‘å…³å…±äº«åŒä¸€ä¸ªé™æµæ•°é‡ï¼Œæ¯ä¸ªç½‘å…³æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åŽï¼Œä»Žè¿œç¨‹æœåŠ¡å™¨ä¸­èŽ·å–å•ä½æ—¶é—´å†…å·²å¤„ç†è¯·æ±‚æ•°ï¼Œå¦‚æžœè¶…è¿‡é™æµï¼Œå°±è¿”å›ž503å“åº”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯èƒ½æŸä¸ªç½‘å…³æœåŠ¡å™¨ä¸€æ®µæ—¶é—´å†…æ ¹æœ¬å°±æ²¡æœ‰è¯·æ±‚åˆ°è¾¾ï¼Œä½†æ˜¯è¿œç¨‹çš„å·²å¤„ç†è¯·æ±‚æ•°å·²ç»è¾¾åˆ°äº†é™æµä¸Šé™ï¼Œé‚£ä¹ˆè¿™å°ç½‘å…³æœåŠ¡å™¨ä¹Ÿå¿…é¡»æ‹’ç»è¯·æ±‚ã€‚æˆ‘ä»¬ä½¿ç”¨Redisä½œä¸ºè®°å½•å•ä½æ—¶é—´è¯·æ±‚æ•°é‡çš„è¿œç¨‹æœåŠ¡å™¨ã€‚

#### **14.2.2 é«˜å¯ç”¨è®¾è®¡**
ä¸ºäº†ä¿è¯é…ç½®ä¸­å¿ƒæœåŠ¡å™¨å’ŒRedisæœåŠ¡å™¨å®•æœºæ—¶ï¼Œé™æµå™¨ç»„ä»¶çš„é«˜å¯ç”¨ã€‚é™æµå™¨åº”å…·æœ‰è‡ªåŠ¨é™çº§åŠŸèƒ½ï¼Œå³é…ç½®ä¸­å¿ƒä¸å¯ç”¨ï¼Œåˆ™ä½¿ç”¨æœ¬åœ°é…ç½®ï¼›RedisæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ™é™çº§ä¸ºæœ¬åœ°é™æµã€‚

### **14.3 è¯¦ç»†è®¾è®¡**
å¸¸ç”¨çš„é™æµç®—æ³•æœ‰4ç§ï¼Œå›ºå®šçª—å£ï¼ˆWindowï¼‰é™æµç®—æ³•ï¼Œæ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰é™æµç®—æ³•ï¼Œæ¼æ¡¶ï¼ˆLeaky Bucketï¼‰é™æµç®—æ³•ï¼Œä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰é™æµç®—æ³•ã€‚æˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºè¿™å››ç§ç®—æ³•çš„å®žçŽ°ã€‚
æ­¤å¤–ï¼Œé™æµå™¨è¿è¡ŒæœŸéœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶èŽ·å–å¯¹å“ªäº›URLè·¯å¾„è¿›è¡Œé™æµï¼›æœ¬åœ°é™æµè¿˜æ˜¯åˆ†å¸ƒå¼é™æµï¼›å¯¹ç”¨æˆ·é™æµè¿˜æ˜¯å¯¹è®¾å¤‡é™æµï¼Œè¿˜æ˜¯å¯¹æ‰€æœ‰è¯·æ±‚é™æµï¼›é™æµçš„é˜ˆå€¼æ˜¯å¤šå°‘ï¼›é˜ˆå€¼çš„æ—¶é—´å•ä½æ˜¯ä»€ä¹ˆï¼›å…·ä½“ä½¿ç”¨å“ªç§é™æµç®—æ³•ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸‹é…ç½®æ–‡ä»¶çš„è®¾è®¡ã€‚

#### **14.3.1 é…ç½®æ–‡ä»¶è®¾è®¡**
Dianaé™æµå™¨ä½¿ç”¨YAMLè¿›è¡Œé…ç½®ï¼Œé…ç½®æ–‡ä»¶ä¸¾ä¾‹å¦‚ä¸‹ï¼š
```
Url:/



rules:



 - actor:device



   unit:second



   rpu:10



   algo:TB



   scope:global- actor:all



   unit:second



   rpu:50



   algo:W



   scope:local
```
é…ç½®æ–‡ä»¶çš„é…ç½®é¡¹æœ‰7ç§ï¼Œåˆ†åˆ«è¯´æ˜Žå¦‚ä¸‹ï¼š

1. Urlè®°å½•é™æµçš„èµ„æºåœ°å€ï¼Œâ€/â€œè¡¨ç¤ºæ‰€æœ‰è¯·æ±‚ï¼Œé…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„å¯ä»¥äº’ç›¸åŒ…å«ï¼Œæ¯”å¦‚â€œ/â€åŒ…å«â€œ/sampleâ€ï¼Œé™æµå™¨è¦å…ˆåŒ¹é…â€œ/â€çš„é™æµè§„åˆ™ï¼Œå¦‚æžœâ€œ/â€çš„é™æµè§„åˆ™è¿˜æ²¡æœ‰è§¦å‘ï¼ˆå³è®¿é—®â€/â€œçš„æµé‡ï¼Œä¹Ÿå°±æ˜¯å•ä½æ—¶é—´æ‰€æœ‰çš„è¯·æ±‚æ€»å’Œæ²¡æœ‰è¾¾åˆ°é™æµè§„åˆ™ï¼‰ï¼Œåˆ™å†åŒ¹é…â€œ/sampleâ€ã€‚
2. æ¯ä¸ªUrlå¯ä»¥é…ç½®å¤šä¸ªè§„åˆ™rulesï¼Œæ¯ä¸ªè§„åˆ™åŒ…æ‹¬actorï¼Œunitï¼Œrpuï¼Œalgoï¼Œscope
3. actorä¸ºé™æµå¯¹è±¡ï¼Œå¯ä»¥æ˜¯è´¦å·ï¼ˆactorï¼‰ï¼Œè®¾å¤‡ï¼ˆdeviceï¼‰ï¼Œå…¨éƒ¨ï¼ˆallï¼‰
4. unitä¸ºé™æµæ—¶é—´å•ä½ï¼Œå¯ä»¥æ˜¯ç§’ï¼ˆsecondï¼‰ï¼Œåˆ†ï¼ˆminuteï¼‰ï¼Œæ—¶ï¼ˆhourï¼‰ï¼Œå¤©ï¼ˆdayï¼‰
5. rpuä¸ºå•ä½æ—¶é—´é™æµè¯·æ±‚æ•°ï¼ˆrequest per unitï¼‰ï¼Œå³ä¸Šé¢unitå®šä¹‰çš„å•ä½æ—¶é—´å†…å…è®¸é€šè¿‡çš„è¯·æ±‚æ•°ç›®ï¼Œå¦‚unitä¸ºsecondï¼Œrpuä¸º100ï¼Œè¡¨ç¤ºæ¯ç§’å…è®¸é€šè¿‡100ä¸ªè¯·æ±‚ï¼Œæ¯ç§’è¶…è¿‡100ä¸ªè¯·æ±‚å°±è¿›è¡Œé™æµï¼Œè¿”å›ž503å“åº”
6. scopeä¸ºrpuç”Ÿæ•ˆèŒƒå›´ï¼Œå¯ä»¥æ˜¯æœ¬åœ°ï¼ˆlocalï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¨å±€ï¼ˆglobalï¼‰ï¼Œscopeä¹Ÿå†³å®šäº†å•ä½æ—¶é—´è¯·æ±‚æ•°é‡æ˜¯è®°å½•åœ¨æœ¬åœ°è¿˜æ˜¯è¿œç¨‹ï¼Œlocalè®°å½•åœ¨æœ¬åœ°ï¼Œglobalè®°å½•åœ¨è¿œç¨‹ã€‚
7. algoé™æµç®—æ³•ï¼Œå¯ä»¥æ˜¯windowï¼Œsliding windowï¼Œleaky bucketï¼Œtoken bucket ã€‚

Dianaæ”¯æŒé…ç½®4ç§é™æµç®—æ³•ï¼Œä½¿ç”¨è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚åœºæ™¯ï¼Œä¸ºä¸åŒèµ„æºåœ°å€é…ç½®ä¸åŒçš„é™æµç®—æ³•ï¼Œä¸‹é¢è¯¦ç»†æè¿°è¿™å››ç§ç®—æ³•å®žçŽ°ã€‚

#### **14.3.2 å›ºå®šçª—å£ï¼ˆWindowï¼‰é™æµç®—æ³•**
å›ºå®šçª—å£é™æµç®—æ³•å°±æ˜¯å°†é…ç½®æ–‡ä»¶ä¸­çš„æ—¶é—´å•ä½unitä½œä¸ºä¸€ä¸ªæ—¶é—´çª—å£ï¼Œæ¯ä¸ªçª—å£ä»…å…è®¸é™åˆ¶æµé‡å†…çš„è¯·æ±‚é€šè¿‡ï¼Œå¦‚å›¾ã€‚
![1720609070042-7225f6e9-062a-4cc0-a69c-ab407e7c8724.jpeg](./img/TtEZ-MYG9c03xyky/1720609070042-7225f6e9-062a-4cc0-a69c-ab407e7c8724-606128.jpeg)
æˆ‘ä»¬å°†æ—¶é—´è½´åˆ‡åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„é™æµçª—å£ï¼Œæ¯ä¸ªé™æµçª—å£æœ‰ä¸€ä¸ªçª—å£å¼€å§‹æ—¶é—´å’Œä¸€ä¸ªçª—å£ç»“æŸæ—¶é—´ï¼Œçª—å£å¼€å§‹æ—¶ï¼Œè®¡æ•°å™¨æ¸…é›¶ï¼Œæ¯è¿›å…¥ä¸€ä¸ªè¯·æ±‚ï¼Œè®¡æ•°å™¨å°±è®°å½•+1ã€‚å¦‚æžœè¯·æ±‚æ•°ç›®è¶…è¿‡rpué…ç½®çš„é™æµè¯·æ±‚æ•°ï¼Œå°±æ‹’ç»æœåŠ¡ï¼Œè¿”å›ž503å“åº”ã€‚å½“å‰é™æµçª—å£ç»“æŸåŽï¼Œå°±è¿›å…¥ä¸‹ä¸ªé™æµçª—å£ï¼Œè®¡æ•°å™¨å†æ¬¡æ¸…é›¶ï¼Œé‡æ–°å¼€å§‹ã€‚å¤„ç†æµç¨‹æ´»åŠ¨å›¾å¦‚ä¸‹ã€‚
![1720609070007-b2a3a89e-88cb-4fcb-8a1d-bd2976c5b966.jpeg](./img/TtEZ-MYG9c03xyky/1720609070007-b2a3a89e-88cb-4fcb-8a1d-bd2976c5b966-686404.jpeg)
ä¸Šå›¾åŒ…æ‹¬â€œåˆå§‹åŒ–â€å’Œâ€œå¤„ç†æµç¨‹â€ä¸¤ä¸ªæ³³é“ã€‚åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè®¾ç½®â€œçª—å£è®¡æ•°å™¨â€å’Œâ€œå½“å‰çª—å£ç»“æŸæ—¶é—´â€ä¸¤ä¸ªå˜é‡ã€‚å¤„ç†è¯·æ±‚çš„æ—¶å€™ï¼Œåˆ¤æ–­å½“å‰æ—¶é—´æ˜¯å¦å¤§äºŽâ€œå½“å‰çª—å£ç»“æŸæ—¶é—´â€ï¼Œå¦‚æžœå¤§äºŽï¼Œé‚£ä¹ˆé‡ç½®â€œçª—å£è®¡æ•°å™¨â€å’Œâ€œå½“å‰çª—å£ç»“æŸæ—¶é—´â€ä¸¤ä¸ªå˜é‡ï¼›å¦‚æžœæ²¡æœ‰ï¼Œçª—å£è®¡æ•°å™¨+1ï¼Œå¹¶åˆ¤æ–­è®¡æ•°å™¨æ˜¯å¦å¤§äºŽé…ç½®çš„é™æµè¯·æ±‚æ•°rpuï¼Œæ ¹æ®ç»“æžœå†³å®šæ˜¯å¦è¿›è¡Œé™æµã€‚
è¿™é‡Œçš„â€œçª—å£è®¡æ•°å™¨â€å¯ä»¥æœ¬åœ°è®°å½•ï¼Œä¹Ÿå¯ä»¥è¿œç¨‹è®°å½•ï¼Œä¹Ÿå°±æ˜¯é…ç½®ä¸­çš„localå’Œglobalã€‚å›ºå®šçª—å£ç®—æ³•åœ¨é…ç½®æ–‡ä»¶ä¸­algoé¡¹å¯é…ç½®â€œwindowâ€æˆ–è€…ç¼©å†™â€œWâ€ã€‚
å›ºå®šçª—å£å®žçŽ°æ¯”è¾ƒå®¹æ˜“ï¼Œä½†æ˜¯å¦‚æžœä½¿ç”¨è¿™ç§é™æµç®—æ³•ï¼Œåœ¨ä¸€ä¸ªé™æµæ—¶é—´å•ä½å†…ï¼Œé€šè¿‡çš„è¯·æ±‚æ•°å¯èƒ½æ˜¯rpuçš„ä¸¤å€ï¼Œæ— æ³•è¾¾åˆ°é™æµçš„ç›®çš„ï¼Œå¦‚ä¸‹å›¾ã€‚
![1720609070438-d41d5d9b-8d16-43c6-b469-a3187751c720.jpeg](./img/TtEZ-MYG9c03xyky/1720609070438-d41d5d9b-8d16-43c6-b469-a3187751c720-609862.jpeg)
å‡è®¾å•ä½æ—¶é—´è¯·æ±‚é™æµæ•°rpuä¸º100ï¼Œåœ¨ç¬¬ä¸€ä¸ªé™æµçª—å£å¿«è¦åˆ°ç»“æŸæ—¶é—´çš„æ—¶å€™ï¼Œçªç„¶è¿›æ¥100ä¸ªè¯·æ±‚ï¼Œå› ä¸ºè¿™ä¸ªè¯·æ±‚é‡åœ¨é™æµèŒƒå›´å†…ï¼Œæ‰€ä»¥æ²¡æœ‰è§¦å‘é™æµï¼Œè¯·æ±‚å…¨éƒ¨é€šè¿‡ã€‚ç„¶åŽè¿›å…¥ç¬¬äºŒä¸ªé™æµçª—å£ï¼Œé™æµè®¡æ•°å™¨æ¸…é›¶ã€‚è¿™æ—¶åˆå¿½ç„¶è¿›å…¥100ä¸ªè¯·æ±‚ï¼Œå› ä¸ºå·²ç»è¿›å…¥ç¬¬äºŒä¸ªé™æµçª—å£ï¼Œæ‰€ä»¥ä¹Ÿæ²¡è§¦å‘é™æµã€‚åœ¨çŸ­æ—¶é—´å†…ï¼Œé€šè¿‡äº†200ä¸ªè¯·æ±‚ï¼Œè¿™æ ·å¯èƒ½ä¼šç»™ç³»ç»Ÿé€ æˆå·¨å¤§çš„è´Ÿè½½åŽ‹åŠ›ã€‚

#### **14.3.3 æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰é™æµç®—æ³•**
æ”¹è¿›å›ºå®šçª—å£ç¼ºé™·çš„æ–¹æ³•æ˜¯é‡‡ç”¨æ»‘åŠ¨çª—å£é™æµç®—æ³•ï¼Œå¦‚ä¸‹å›¾ã€‚
![1720609070424-5af3a055-675c-4162-859d-de60f57b8c7f.jpeg](./img/TtEZ-MYG9c03xyky/1720609070424-5af3a055-675c-4162-859d-de60f57b8c7f-314739.jpeg)
æ»‘åŠ¨çª—å£å°±æ˜¯å°†é™æµçª—å£å†…éƒ¨åˆ‡åˆ†æˆä¸€äº›æ›´å°çš„æ—¶é—´ç‰‡ï¼Œç„¶åŽåœ¨æ—¶é—´è½´ä¸Šæ»‘åŠ¨ï¼Œæ¯æ¬¡æ»‘åŠ¨ï¼Œæ»‘è¿‡ä¸€ä¸ªå°æ—¶é—´ç‰‡ï¼Œå°±å½¢æˆä¸€ä¸ªæ–°çš„é™æµçª—å£ï¼Œå³æ»‘åŠ¨çª—å£ã€‚ç„¶åŽåœ¨è¿™ä¸ªæ»‘åŠ¨çª—å£å†…æ‰§è¡Œå›ºå®šçª—å£ç®—æ³•å³å¯ã€‚
æ»‘åŠ¨çª—å£å¯ä»¥é¿å…å›ºå®šçª—å£å‡ºçŽ°çš„æ”¾è¿‡ä¸¤å€è¯·æ±‚çš„é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªçŸ­æ—¶é—´å†…å‡ºçŽ°çš„æ‰€æœ‰è¯·æ±‚å¿…ç„¶åœ¨ä¸€ä¸ªæ»‘åŠ¨çª—å£å†…ï¼Œæ‰€ä»¥ä¸€å®šä¼šè¢«æ»‘åŠ¨çª—å£é™æµã€‚
æ»‘åŠ¨çª—å£çš„ç®—æ³•å®žçŽ°åŸºæœ¬å’Œå›ºå®šçª—å£ä¸€è‡´ï¼Œåªè¦æ”¹åŠ¨é‡ç½®â€œçª—å£è®¡æ•°å™¨â€å’Œâ€œå½“å‰çª—å£ç»“æŸæ—¶é—´â€çš„é€»è¾‘å°±å¯ä»¥ã€‚å›ºå®šçª—å£ç®—æ³•é‡ç½®ä¸ºçª—å£ç»“æŸæ—¶é—´+1 unit æ—¶é—´ï¼Œæ»‘åŠ¨çª—å£ç®—æ³•é‡ç½®ä¸ºçª—å£ç»“æŸæ—¶é—´+1ä¸ªæ—¶é—´ç‰‡ã€‚ä½†æ˜¯å›ºå®šçª—å£ç®—æ³•é‡ç½®åŽï¼Œçª—å£è®¡æ•°å™¨ä¸º0ï¼Œè€Œæ»‘åŠ¨çª—å£éœ€è¦å°†çª—å£è®¡æ•°å™¨è®¾ç½®ä¸ºå½“å‰çª—å£å·²ç»ç»è¿‡çš„æ—¶é—´ç‰‡çš„è¯·æ±‚æ€»æ•°ï¼Œæ¯”å¦‚ä¸Šå›¾é‡Œï¼Œä¸€ä¸ªæ»‘åŠ¨çª—å£è¢«åˆ†ä¸º5ä¸ªæ—¶é—´ç‰‡ï¼Œæ»‘åŠ¨çª—å£2çš„æµ…è“è‰²éƒ¨åˆ†å°±æ˜¯å·²ç»ç»è¿‡äº†4ä¸ªæ—¶é—´ç‰‡ã€‚
æ»‘åŠ¨çª—å£ç®—æ³•åœ¨é…ç½®æ–‡ä»¶ä¸­algoé¡¹å¯é…ç½®â€œsliding windowâ€æˆ–è€…ç¼©å†™â€œSWâ€ã€‚

#### **14.3.4 æ¼æ¡¶ï¼ˆLeaky Bucketï¼‰é™æµç®—æ³•**
æ¼æ¡¶é™æµç®—æ³•æ˜¯æ¨¡æ‹Ÿæ°´æµè¿‡ä¸€ä¸ªæœ‰æ¼æ´žçš„æ¡¶è¿›è€Œé™æµçš„æ€è·¯ï¼Œå¦‚å›¾ã€‚
![1720609070448-bb3a45b7-b968-4e6b-a186-7b1cc7849566.png](./img/TtEZ-MYG9c03xyky/1720609070448-bb3a45b7-b968-4e6b-a186-7b1cc7849566-850952.png)
æ°´é¾™å¤´çš„æ°´å…ˆæµå…¥æ¼æ¡¶ï¼Œå†é€šè¿‡æ¼æ¡¶åº•éƒ¨çš„å­”æµå‡ºã€‚å¦‚æžœæµå…¥çš„æ°´é‡å¤ªå¤§ï¼Œåº•éƒ¨çš„å­”æ¥ä¸åŠæµå‡ºï¼Œå°±ä¼šå¯¼è‡´æ°´æ¡¶å¤ªæ»¡æº¢å‡ºåŽ»ã€‚
é™æµå™¨åˆ©ç”¨æ¼æ¡¶çš„è¿™ä¸ªåŽŸç†è®¾è®¡æ¼æ¡¶é™æµç®—æ³•ï¼Œç”¨æˆ·è¯·æ±‚å…ˆæµå…¥åˆ°ä¸€ä¸ªç‰¹å®šå¤§å°çš„æ¼æ¡¶ä¸­ï¼Œç³»ç»Ÿä»¥ç‰¹å®šçš„é€ŸçŽ‡ä»Žæ¼æ¡¶ä¸­èŽ·å–è¯·æ±‚å¹¶å¤„ç†ã€‚å¦‚æžœç”¨æˆ·è¯·æ±‚è¶…è¿‡é™æµï¼Œå°±ä¼šå¯¼è‡´æ¼æ¡¶è¢«è¯·æ±‚æ•°æ®å¡«æ»¡ï¼Œè¯·æ±‚æº¢å‡ºï¼Œè¿”å›ž503å“åº”ã€‚
æ‰€ä»¥æ¼æ¡¶ç®—æ³•ä¸ä»…å¯ä»¥é™æµï¼Œå½“æµé‡è¶…è¿‡é™åˆ¶çš„æ—¶å€™ä¼šæ‹’ç»å¤„ç†ï¼Œç›´æŽ¥è¿”å›ž503å“åº”ï¼Œè¿˜èƒ½æŽ§åˆ¶è¯·æ±‚çš„å¤„ç†é€Ÿåº¦ã€‚
å®žè·µä¸­ï¼Œå¯ä»¥é‡‡ç”¨é˜Ÿåˆ—å½“åšæ¼æ¡¶ã€‚å¦‚å›¾ã€‚
![1720609070562-831fd6b7-9377-49cd-ba91-f280ccc2e53f.png](./img/TtEZ-MYG9c03xyky/1720609070562-831fd6b7-9377-49cd-ba91-f280ccc2e53f-605403.png)
æž„å»ºä¸€ä¸ªç‰¹å®šé•¿åº¦çš„é˜Ÿåˆ—queueä½œä¸ºæ¼æ¡¶ï¼Œå¼€å§‹çš„æ—¶å€™ï¼Œé˜Ÿåˆ—ä¸ºç©ºï¼Œç”¨æˆ·è¯·æ±‚åˆ°è¾¾åŽä»Žé˜Ÿåˆ—å°¾éƒ¨å†™å…¥é˜Ÿåˆ—ï¼Œè€Œåº”ç”¨ç¨‹åºä»Žé˜Ÿåˆ—å¤´éƒ¨ä»¥ç‰¹å®šé€ŸçŽ‡è¯»å–è¯·æ±‚ã€‚å½“è¯»å–é€Ÿåº¦ä½ŽäºŽå†™å…¥é€Ÿåº¦çš„æ—¶å€™ï¼Œä¸€æ®µæ—¶é—´åŽï¼Œé˜Ÿåˆ—ä¼šè¢«å†™æ»¡ï¼Œè¿™æ—¶å€™å†™å…¥é˜Ÿåˆ—æ“ä½œå¤±è´¥ã€‚å†™å…¥å¤±è´¥çš„è¯·æ±‚ç›´æŽ¥æž„é€ 503å“åº”è¿”å›žã€‚
ä½†æ˜¯ä½¿ç”¨é˜Ÿåˆ—è¿™ç§æ–¹å¼ï¼Œå®žé™…ä¸Šæ˜¯æŠŠè¯·æ±‚å¤„ç†å¼‚æ­¥åŒ–äº†ï¼ˆå†™å…¥è¯·æ±‚çš„çº¿ç¨‹å’ŒèŽ·å–è¯·æ±‚çš„çº¿ç¨‹ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œå¹¶ä¸é€‚åˆæˆ‘ä»¬ç›®å‰åŒæ­¥ç½‘å…³çš„åœºæ™¯ï¼ˆå¦‚æžœä½¿ç”¨å‰é¢è®¾è®¡è¿‡çš„Floweræ¡†æž¶å¼€å‘çš„å¼‚æ­¥ç½‘å…³å°±å¯ä»¥ç”¨è¿™ç§é˜Ÿåˆ—æ–¹å¼ï¼‰ã€‚
å› æ­¤Dianaå®žçŽ°æ¼æ¡¶é™æµç®—æ³•å¹¶ä¸ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œæ˜¯é˜»å¡žç­‰å¾…ã€‚æ ¹æ®é™æµé…ç½®æ–‡ä»¶è®¡ç®—æ¯ä¸ªè¯·æ±‚ä¹‹é—´çš„é—´éš”æ—¶é—´ï¼Œä¾‹å¦‚ï¼šé™æµæ¯ç§’10ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆæ¯ä¸¤ä¸ªè¯·æ±‚çš„é—´éš”æ—¶é—´å°±å¿…é¡»>=100msã€‚ç”¨æˆ·è¯·æ±‚åˆ°è¾¾é™æµå™¨åŽï¼Œæ ¹æ®å½“å‰æœ€è¿‘ä¸€ä¸ªè¯·æ±‚å¤„ç†çš„æ—¶é—´å’Œé˜»å¡žçš„è¯·æ±‚çº¿ç¨‹æ•°ç›®ï¼Œè®¡ç®—å½“å‰è¯·æ±‚çº¿ç¨‹çš„sleepæ—¶é—´ã€‚æ¯ä¸ªè¯·æ±‚çº¿ç¨‹çš„sleepæ—¶é—´ä¸åŒï¼Œæœ€åŽå°±å¯ä»¥å®žçŽ°æ¯éš”100mså”¤é†’ä¸€ä¸ªè¯·æ±‚çº¿ç¨‹åŽ»å¤„ç†ï¼Œä»Žè€Œè¾¾åˆ°æ¼æ¡¶é™æµçš„æ•ˆæžœã€‚
è®¡ç®—è¯·æ±‚çº¿ç¨‹sleepæ—¶é—´çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š
```
åˆå§‹åŒ– :



é—´éš”æ—¶é—´ = 100ms;



é˜»å¡žçº¿ç¨‹æ•° = 0;



æœ€è¿‘è¯·æ±‚å¤„ç†æ—¶é—´æˆ³  = 0ï¼›



 



long sleepæ—¶é—´(){



  //æœ€è¿‘æ²¡æœ‰è¯·æ±‚ï¼Œä¸é˜»å¡žif((now - æœ€è¿‘è¯·æ±‚å¤„ç†æ—¶é—´æˆ³ï¼‰ >= é—´éš”æ—¶é—´ and é˜»å¡žçº¿ç¨‹æ•° <= 0ï¼‰{



    æœ€è¿‘è¯·æ±‚å¤„ç†æ—¶é—´æˆ³ = now;



    return0; //ä¸é˜»å¡ž



  }



  //æŽ’é˜Ÿè¯·æ±‚å¤ªå¤šï¼Œæ¼æ¡¶æº¢å‡ºif(é˜»å¡žçº¿ç¨‹æ•° > æœ€å¤§æº¢å‡ºçº¿ç¨‹æ•°) {



    return MAX_TIME;//MAX_TIMEè¡¨ç¤ºé˜»å¡žæ—¶é—´æ— ç©·å¤§ï¼Œå½“å‰è¯·æ±‚è¢«é™æµ



  }



  //è¯·æ±‚åœ¨æŽ’é˜Ÿï¼Œé˜»å¡žç­‰å¾…



    é˜»å¡žçº¿ç¨‹æ•°++;



    return é—´éš”æ—¶é—´ * é˜»å¡žçº¿ç¨‹æ•° - (now - æœ€è¿‘è¯·æ±‚å¤„ç†æ—¶é—´æˆ³) ;



}
```
è¯·æ±‚çº¿ç¨‹sleepæ—¶é—´ç»“æŸï¼Œç»§ç»­æ‰§è¡Œçš„æ—¶å€™ï¼Œä¿®æ”¹é˜»å¡žçº¿ç¨‹æ•°ï¼š
```sql
æœ€è¿‘è¯·æ±‚å¤„ç†æ—¶é—´æˆ³ = now;



é˜»å¡žçº¿ç¨‹æ•°--;
```
æ³¨æ„ï¼Œä»¥ä¸Šä»£ç å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œéœ€è¦è¿›è¡ŒåŠ é”æ“ä½œã€‚
ä½¿ç”¨æ¼æ¡¶é™æµç®—æ³•ï¼Œå³ä½¿ç³»ç»Ÿèµ„æºå¾ˆç©ºé—²ï¼Œå¤šä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾æ—¶ï¼Œæ¼æ¡¶ä¹Ÿæ˜¯æ…¢æ…¢åœ°ä¸€ä¸ªæŽ¥ä¸€ä¸ªåœ°åŽ»å¤„ç†è¯·æ±‚ï¼Œè¿™å…¶å®žå¹¶ä¸ç¬¦åˆäººä»¬çš„æœŸæœ›ï¼Œå› ä¸ºè¿™æ ·å°±æ˜¯åœ¨æµªè´¹è®¡ç®—èµ„æºã€‚å› æ­¤é™¤éžæœ‰ç‰¹åˆ«çš„åœºæ™¯éœ€æ±‚ï¼Œå¦åˆ™ä¸æŽ¨èä½¿ç”¨è¯¥ç®—æ³•ã€‚
æ¼æ¡¶ç®—æ³•çš„algoé…ç½®é¡¹åç§°ä¸ºâ€œleaky bucketâ€æˆ–è€…â€œLBâ€ã€‚

##### **ä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰é™æµç®—æ³•**
ä»¤ç‰Œæ¡¶æ˜¯å¦ä¸€ç§æ¡¶é™æµç®—æ³•ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªç‰¹å®šå¤§å°çš„æ¡¶ï¼Œç„¶åŽå‘æ¡¶ä¸­ä»¥ç‰¹å®šçš„é€Ÿåº¦æ”¾å…¥ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œè¯·æ±‚åˆ°è¾¾åŽï¼Œå¿…é¡»ä»Žæ¡¶ä¸­å–å‡ºä¸€ä¸ªä»¤ç‰Œæ‰èƒ½ç»§ç»­å¤„ç†ã€‚å¦‚æžœæ¡¶ä¸­å·²ç»æ²¡æœ‰ä»¤ç‰Œäº†ï¼Œé‚£ä¹ˆå½“å‰è¯·æ±‚å°±è¢«é™æµï¼Œè¿”å›ž503å“åº”ã€‚å¦‚æžœæ¡¶ä¸­çš„ä»¤ç‰Œæ”¾æ»¡äº†ï¼Œä»¤ç‰Œæ¡¶ä¹Ÿä¼šæº¢å‡ºã€‚
![1720609070673-67ac3d2f-8dec-4d79-9249-3aacba7c421f.png](./img/TtEZ-MYG9c03xyky/1720609070673-67ac3d2f-8dec-4d79-9249-3aacba7c421f-633109.png)
ä¸Šé¢çš„ç®—æ³•æè¿°ä¼¼ä¹Žéœ€è¦æœ‰ä¸€ä¸ªä¸“é—¨çº¿ç¨‹ç”Ÿæˆä»¤ç‰Œï¼Œè¿˜éœ€è¦ä¸€ä¸ªæ•°æ®ç»“æž„æ¨¡æ‹Ÿæ¡¶ã€‚å®žé™…ä¸Šï¼Œä»¤ç‰Œæ¡¶çš„å®žçŽ°ï¼Œåªéœ€è¦åœ¨è¯·æ±‚èŽ·å–ä»¤ç‰Œçš„æ—¶å€™ï¼Œé€šè¿‡æ—¶é—´è®¡ç®—ï¼Œå°±å¯ä»¥ç®—å‡ºä»¤ç‰Œæ¡¶ä¸­çš„æ€»ä»¤ç‰Œæ•°ã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š
```
åˆå§‹åŒ– :



æœ€è¿‘ç”Ÿæˆä»¤ç‰Œæ—¶é—´æˆ³ = 0ï¼›



æ€»ä»¤ç‰Œæ•° = 0ï¼›



ä»¤ç‰Œç”Ÿæˆæ—¶é—´é—´éš” = 100ms;



 



boolean èŽ·å–ä»¤ç‰Œ(){



  //ä»¤ç‰Œæ¡¶ä¸­æœ‰ä»¤ç‰Œï¼Œç›´æŽ¥å–ä»¤ç‰Œå³å¯if(æ€»ä»¤ç‰Œæ•° >= 1){



    æ€»ä»¤ç‰Œæ•°--ï¼›



    returntrue;



  }



  //ä»¤ç‰Œæ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œäº†ï¼Œé‡ç®—çŽ°åœ¨ä»¤ç‰Œæ¡¶ä¸­çš„æ€»ä»¤ç‰Œæ•°ï¼Œå¯èƒ½ç®—å‡ºçš„æ€»ä»¤ç‰Œæ•°ä¾ç„¶ä¸º0



  æ€»ä»¤ç‰Œæ•° = min(ä»¤ç‰Œæ•°ä¸Šé™å€¼ï¼Œæ€»ä»¤ç‰Œæ•° + 



  (now - æœ€è¿‘ç”Ÿæˆä»¤ç‰Œæ—¶é—´æˆ³) / ä»¤ç‰Œç”Ÿæˆæ—¶é—´é—´éš”)ï¼›



  if(æ€»ä»¤ç‰Œæ•° >= 1){



    æ€»ä»¤ç‰Œæ•°--ï¼›



    æœ€è¿‘ç”Ÿæˆä»¤ç‰Œæ—¶é—´æˆ³ = nowï¼›//æœ‰ä»¤ç‰Œäº†ï¼Œæ‰èƒ½é‡è®¾æ—¶é—´returntrueï¼›



  }



  returnfalseï¼›



}
```
ä»¤ç‰Œæ¡¶é™æµç®—æ³•ç»¼åˆæ•ˆæžœæ¯”è¾ƒå¥½ï¼Œèƒ½åœ¨æœ€å¤§ç¨‹åº¦åˆ©ç”¨ç³»ç»Ÿèµ„æºå¤„ç†è¯·æ±‚çš„åŸºç¡€ä¸Šï¼Œå®žçŽ°é™æµçš„ç›®æ ‡ï¼Œå»ºè®®é€šå¸¸åœºæ™¯ä¸­ä¼˜å…ˆä½¿ç”¨è¯¥ç®—æ³•ï¼ŒDianaçš„ç¼ºçœé…ç½®ç®—æ³•ä¹Ÿæ˜¯ä»¤ç‰Œæ¡¶ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•çš„algoé…ç½®é¡¹åç§°ä¸ºâ€œtoken bucketâ€æˆ–â€œTBâ€ã€‚


> åŽŸæ–‡: <https://www.yuque.com/tulingzhouyu/db22bv/wi1cmg1fhxdofwls>