# ğŸ’ç½‘ç»œé¢è¯•é¢˜é›†åˆ


# å®æ—¶æ¶ˆæ¯æ¨é€çš„æ–¹æ¡ˆ

## åœºæ™¯ï¼š
æˆ‘ä»¬éƒ½é‡åˆ°è¿‡è¿™ç§åœºæ™¯ï¼š

1. åœ¨åˆ·çŸ­è§†é¢‘çš„æ—¶å€™å½“åˆ«äººè¯„è®ºæˆ–è€…ç‚¹èµäº†ä½ çš„è§†é¢‘ï¼Œç³»ç»Ÿä¼šä¸»åŠ¨ç»™ä½ æ¨é€ä¸€æ¡åŠ¨æ€ã€‚

![image.png](./img/3_UGzUXuAAUrsBku/1715002891567-d635653c-88e3-4abe-874c-8ee4c31a46b4-770170.png)

2. åœ¨è·Ÿåˆ«äººåœ¨çº¿èŠå¤©çš„æ—¶å€™ä¹Ÿéœ€è¦å®æ—¶æ„ŸçŸ¥åˆ°

![output.gif](./img/3_UGzUXuAAUrsBku/1715003025380-7d1f2ed5-c356-4a18-95f6-fdc126a58a77-384415.gif)
 3. åœ¨è¿›è¡Œå¤šäººåœ¨çº¿æ¸¸æˆçš„æ—¶å€™éœ€è¦å®æ—¶çŸ¥é“åˆ«äººå‡ºçš„ç‰Œå’Œé‡Šæ”¾çš„æŠ€èƒ½ï¼š
![image.png](./img/3_UGzUXuAAUrsBku/1715002965207-753edff8-91d6-43ce-b1c5-7d2c4f192e38-823683.png)
4.ç”šè‡³åœ¨çº¿ä¸‹ä½¿ç”¨ä¸€äº›å…±äº«è®¾å¤‡æ¯”å¦‚å…±äº«å•è½¦ï¼Œ å½“åœ¨æ‰‹æœºç‚¹å‡»â€œå¼€é”â€ï¼Œç³»ç»Ÿä¹Ÿä¼šå®æ—¶æ¨é€æ¶ˆæ¯ç»™å…±äº«å•è½¦è¿›è¡Œå¼€é”ï¼š
![image.png](./img/3_UGzUXuAAUrsBku/1715003118447-0cc2b5ac-74ef-4c52-ac98-f8434d0146a1-827015.png)

ç»™å¤§å®¶ä»‹ç»å‡ ä¸ªå¸¸è§çš„å®ç°æ–¹æ¡ˆï¼š
![1715003392174-8fc40e7d-ddd8-4946-8036-46a70812e677.jpeg](./img/3_UGzUXuAAUrsBku/1715003392174-8fc40e7d-ddd8-4946-8036-46a70812e677-047020.jpeg)

## Githubåœ°å€
æ–‡ä¸­æ‰€æåˆ°çš„æ¡ˆä¾‹æˆ‘éƒ½ä¸€ä¸€çš„åšäº†å®ç°
 [https://gitee.com/xscodeit/xushu_springboot_demos.git](https://gitee.com/xscodeit/xushu_springboot_demos.git)

## çŸ­è½®è¯¢
è½®è¯¢(polling)åº”è¯¥æ˜¯å®ç°æ¶ˆæ¯æ¨é€æ–¹æ¡ˆä¸­æœ€ç®€å•çš„ä¸€ç§ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚ä¸”å°†è½®è¯¢åˆ†ä¸ºçŸ­è½®è¯¢å’Œé•¿è½®è¯¢ã€‚

çŸ­è½®è¯¢å¾ˆå¥½ç†è§£ï¼ŒæŒ‡å®šçš„æ—¶é—´é—´éš”ï¼Œç”±æµè§ˆå™¨å‘æœåŠ¡å™¨å‘å‡ºHTTPè¯·æ±‚ï¼ŒæœåŠ¡å™¨å®æ—¶è¿”å›æœªè¯»æ¶ˆæ¯æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œæµè§ˆå™¨å†åšæ¸²æŸ“æ˜¾ç¤ºã€‚
ä¸€ä¸ªç®€å•çš„JSå®šæ—¶å™¨å°±å¯ä»¥æå®šï¼Œæ¯ç§’é’Ÿè¯·æ±‚ä¸€æ¬¡æœªè¯»æ¶ˆæ¯æ•°æ¥å£ï¼Œè¿”å›çš„æ•°æ®å±•ç¤ºå³å¯ã€‚
```
setInterval(() => {
  // æ–¹æ³•è¯·æ±‚
  messageCount().then((res) => {
      if (res.code === 200) {
          this.messageCount = res.data
      }
  })
}, 1000);
```
æ•ˆæœè¿˜æ˜¯å¯ä»¥çš„ï¼ŒçŸ­è½®è¯¢å®ç°å›ºç„¶ç®€å•ï¼Œç¼ºç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§ï¼Œç”±äºæ¨é€æ•°æ®å¹¶ä¸ä¼šé¢‘ç¹å˜æ›´ï¼Œæ— è®ºåç«¯æ­¤æ—¶æ˜¯å¦æœ‰æ–°çš„æ¶ˆæ¯äº§ç”Ÿï¼Œå®¢æˆ·ç«¯éƒ½ä¼šè¿›è¡Œè¯·æ±‚ï¼ŒåŠ¿å¿…ä¼šå¯¹æœåŠ¡ç«¯é€ æˆå¾ˆå¤§å‹åŠ›ï¼Œæµªè´¹å¸¦å®½å’ŒæœåŠ¡å™¨èµ„æºã€‚
![1715003408489-0a5a9d4d-249b-4a72-b4aa-586c10821057.gif](./img/3_UGzUXuAAUrsBku/1715003408489-0a5a9d4d-249b-4a72-b4aa-586c10821057-364120.gif)

## é•¿è½®è¯¢
é•¿è½®è¯¢æ˜¯å¯¹ä¸Šè¾¹çŸ­è½®è¯¢çš„ä¸€ç§æ”¹è¿›ç‰ˆæœ¬ï¼Œåœ¨å°½å¯èƒ½å‡å°‘å¯¹æœåŠ¡å™¨èµ„æºæµªè´¹çš„åŒæ—¶ï¼Œä¿è¯æ¶ˆæ¯çš„ç›¸å¯¹å®æ—¶æ€§ã€‚é•¿è½®è¯¢åœ¨ä¸­é—´ä»¶ä¸­åº”ç”¨çš„å¾ˆå¹¿æ³›ï¼Œæ¯”å¦‚Nacoså’Œapolloé…ç½®ä¸­å¿ƒï¼Œæ¶ˆæ¯é˜Ÿåˆ—kafkaã€RocketMQä¸­éƒ½æœ‰ç”¨åˆ°é•¿è½®è¯¢ã€‚
è¿™æ¬¡æˆ‘ä½¿ç”¨apolloé…ç½®ä¸­å¿ƒå®ç°é•¿è½®è¯¢çš„æ–¹å¼ï¼Œåº”ç”¨äº†ä¸€ä¸ªç±»DeferredResultï¼Œå®ƒæ˜¯åœ¨servelet3.0åç»è¿‡Springå°è£…æä¾›çš„ä¸€ç§å¼‚æ­¥è¯·æ±‚æœºåˆ¶ï¼Œç›´æ„å°±æ˜¯å»¶è¿Ÿç»“æœã€‚
![1715003408628-88d67391-0284-43ea-8d78-424d845c811f.png](./img/3_UGzUXuAAUrsBku/1715003408628-88d67391-0284-43ea-8d78-424d845c811f-517124.png)
DeferredResultå¯ä»¥å…è®¸å®¹å™¨çº¿ç¨‹å¿«é€Ÿé‡Šæ”¾å ç”¨çš„èµ„æºï¼Œä¸é˜»å¡è¯·æ±‚çº¿ç¨‹ï¼Œä»¥æ­¤æ¥å—æ›´å¤šçš„è¯·æ±‚æå‡ç³»ç»Ÿçš„ååé‡ï¼Œç„¶åå¯åŠ¨å¼‚æ­¥å·¥ä½œçº¿ç¨‹å¤„ç†çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†å®Œæˆè°ƒç”¨DeferredResult.setResult(200)æäº¤å“åº”ç»“æœã€‚
ä¸‹è¾¹æˆ‘ä»¬ç”¨é•¿è½®è¯¢æ¥å®ç°æ¶ˆæ¯æ¨é€ã€‚
å› ä¸ºä¸€ä¸ªIDå¯èƒ½ä¼šè¢«å¤šä¸ªé•¿è½®è¯¢è¯·æ±‚ç›‘å¬ï¼Œæ‰€ä»¥æˆ‘é‡‡ç”¨äº†guavaåŒ…æä¾›çš„Multimapç»“æ„å­˜æ”¾é•¿è½®è¯¢ï¼Œä¸€ä¸ªkeyå¯ä»¥å¯¹åº”å¤šä¸ªvalueã€‚ä¸€æ—¦ç›‘å¬åˆ°keyå‘ç”Ÿå˜åŒ–ï¼Œå¯¹åº”çš„æ‰€æœ‰é•¿è½®è¯¢éƒ½ä¼šå“åº”ã€‚å‰ç«¯å¾—åˆ°éè¯·æ±‚è¶…æ—¶çš„çŠ¶æ€ç ï¼ŒçŸ¥æ™“æ•°æ®å˜æ›´ï¼Œä¸»åŠ¨æŸ¥è¯¢æœªè¯»æ¶ˆæ¯æ•°æ¥å£ï¼Œæ›´æ–°é¡µé¢æ•°æ®ã€‚
```
@Controller
@RequestMapping("/polling")
public class PollingController {

    // å­˜æ”¾ç›‘å¬æŸä¸ªIdçš„é•¿è½®è¯¢é›†åˆ
    // çº¿ç¨‹åŒæ­¥ç»“æ„
    public static Multimap<String, DeferredResult<String>> watchRequests = Multimaps.synchronizedMultimap(HashMultimap.create());

    /**
     * ä½œè€…ï¼šå¾åº¶
     * è®¾ç½®ç›‘å¬
     */
    @GetMapping(path = "watch/{id}")
    @ResponseBody
    public DeferredResult<String> watch(@PathVariable String id) {
        // å»¶è¿Ÿå¯¹è±¡è®¾ç½®è¶…æ—¶æ—¶é—´
        DeferredResult<String> deferredResult = new DeferredResult<>(TIME_OUT);
        // å¼‚æ­¥è¯·æ±‚å®Œæˆæ—¶ç§»é™¤ keyï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
        deferredResult.onCompletion(() -> {
            watchRequests.remove(id, deferredResult);
        });
        // æ³¨å†Œé•¿è½®è¯¢è¯·æ±‚
        watchRequests.put(id, deferredResult);
        return deferredResult;
    }

    /**
     * ä½œè€…ï¼šå¾åº¶
     * å˜æ›´æ•°æ®
     */
    @GetMapping(path = "publish/{id}")
    @ResponseBody
    public String publish(@PathVariable String id) {
        // æ•°æ®å˜æ›´ å–å‡ºç›‘å¬IDçš„æ‰€æœ‰é•¿è½®è¯¢è¯·æ±‚ï¼Œå¹¶ä¸€ä¸€å“åº”å¤„ç†
        if (watchRequests.containsKey(id)) {
            Collection<DeferredResult<String>> deferredResults = watchRequests.get(id);
            for (DeferredResult<String> deferredResult : deferredResults) {
                deferredResult.setResult("æˆ‘æ›´æ–°äº†" + new Date());
            }
        }
        return "success";
    }
```
å½“è¯·æ±‚è¶…è¿‡è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œä¼šæŠ›å‡ºAsyncRequestTimeoutExceptionå¼‚å¸¸ï¼Œè¿™é‡Œç›´æ¥ç”¨@ControllerAdviceå…¨å±€æ•è·ç»Ÿä¸€è¿”å›å³å¯ï¼Œå‰ç«¯è·å–çº¦å®šå¥½çš„çŠ¶æ€ç åå†æ¬¡å‘èµ·é•¿è½®è¯¢è¯·æ±‚ï¼Œå¦‚æ­¤å¾€å¤è°ƒç”¨ã€‚
```
@ControllerAdvice
public class AsyncRequestTimeoutHandler {

    @ResponseStatus(HttpStatus.NOT_MODIFIED)
    @ResponseBody
    @ExceptionHandler(AsyncRequestTimeoutException.class)
    public String asyncRequestTimeoutHandler(AsyncRequestTimeoutException e) {
        System.out.println("å¼‚æ­¥è¯·æ±‚è¶…æ—¶");
        return "304";
    }
}
```
æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œé¦–å…ˆé¡µé¢å‘èµ·é•¿è½®è¯¢è¯·æ±‚/polling/watch/10086ç›‘å¬æ¶ˆæ¯æ›´å˜ï¼Œè¯·æ±‚è¢«æŒ‚èµ·ï¼Œä¸å˜æ›´æ•°æ®ç›´è‡³è¶…æ—¶ï¼Œå†æ¬¡å‘èµ·äº†é•¿è½®è¯¢è¯·æ±‚ï¼›ç´§æ¥ç€æ‰‹åŠ¨å˜æ›´æ•°æ®/polling/publish/10086ï¼Œé•¿è½®è¯¢å¾—åˆ°å“åº”ï¼Œå‰ç«¯å¤„ç†ä¸šåŠ¡é€»è¾‘å®Œæˆåå†æ¬¡å‘èµ·è¯·æ±‚ï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚
![1715003408592-40f195b1-3a4a-4942-9b86-77faae6b718f.gif](./img/3_UGzUXuAAUrsBku/1715003408592-40f195b1-3a4a-4942-9b86-77faae6b718f-324284.gif)
é•¿è½®è¯¢ç›¸æ¯”äºçŸ­è½®è¯¢åœ¨æ€§èƒ½ä¸Šæå‡äº†å¾ˆå¤šï¼Œä½†ä¾ç„¶ä¼šäº§ç”Ÿè¾ƒå¤šçš„è¯·æ±‚ï¼Œè¿™æ˜¯å®ƒçš„ä¸€ç‚¹ä¸å®Œç¾çš„åœ°æ–¹ã€‚


## SSE


å¾ˆå¤šäººå¯èƒ½ä¸çŸ¥é“ï¼ŒæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œå…¶å®é™¤äº†å¯ä»¥ç”¨WebSocketè¿™ç§è€³ç†Ÿèƒ½è¯¦çš„æœºåˆ¶å¤–ï¼Œè¿˜æœ‰ä¸€ç§æœåŠ¡å™¨å‘é€äº‹ä»¶(Server-sent events)ï¼Œç®€ç§°SSEã€‚
SSEå®ƒæ˜¯åŸºäºHTTPåè®®çš„ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€èˆ¬æ„ä¹‰ä¸Šçš„HTTPåè®®æ˜¯æ— æ³•åšåˆ°æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯çš„ï¼Œä½†SSEæ˜¯ä¸ªä¾‹å¤–ï¼Œå®ƒå˜æ¢äº†ä¸€ç§æ€è·¯ã€‚
![1715003409068-81a56155-a371-4cc2-aa49-8fa6d9758f53.png](./img/3_UGzUXuAAUrsBku/1715003409068-81a56155-a371-4cc2-aa49-8fa6d9758f53-131686.png)
SSEåœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´æ‰“å¼€ä¸€ä¸ªå•å‘é€šé“ï¼ŒæœåŠ¡ç«¯å“åº”çš„ä¸å†æ˜¯ä¸€æ¬¡æ€§çš„æ•°æ®åŒ…è€Œæ˜¯text/event-streamç±»å‹çš„æ•°æ®æµä¿¡æ¯ï¼Œåœ¨æœ‰æ•°æ®å˜æ›´æ—¶ä»æœåŠ¡å™¨æµå¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚
æ•´ä½“çš„å®ç°æ€è·¯æœ‰ç‚¹ç±»ä¼¼äºåœ¨çº¿è§†é¢‘æ’­æ”¾ï¼Œè§†é¢‘æµä¼šè¿ç»­ä¸æ–­çš„æ¨é€åˆ°æµè§ˆå™¨ï¼Œä½ ä¹Ÿå¯ä»¥ç†è§£æˆï¼Œå®¢æˆ·ç«¯åœ¨å®Œæˆä¸€æ¬¡ç”¨æ—¶å¾ˆé•¿ï¼ˆç½‘ç»œä¸ç•…ï¼‰çš„ä¸‹è½½ã€‚
![1715003409010-880e58d0-0477-4e4e-9c32-4f16da43ffa8.png](./img/3_UGzUXuAAUrsBku/1715003409010-880e58d0-0477-4e4e-9c32-4f16da43ffa8-203781.png)
SSEä¸WebSocketä½œç”¨ç›¸ä¼¼ï¼Œéƒ½å¯ä»¥å»ºç«‹æœåŠ¡ç«¯ä¸æµè§ˆå™¨ä¹‹é—´çš„é€šä¿¡ï¼Œå®ç°æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼Œä½†è¿˜æ˜¯æœ‰äº›è®¸ä¸åŒï¼š

- **SSE æ˜¯åŸºäºHTTPåè®®çš„ï¼Œå®ƒä»¬ä¸éœ€è¦ç‰¹æ®Šçš„åè®®æˆ–æœåŠ¡å™¨å®ç°å³å¯å·¥ä½œï¼›WebSocketéœ€å•ç‹¬æœåŠ¡å™¨æ¥å¤„ç†åè®®ã€‚**
- **SSE å•å‘é€šä¿¡ï¼Œåªèƒ½ç”±æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å•å‘é€šä¿¡ï¼›webSocketå…¨åŒå·¥é€šä¿¡ï¼Œå³é€šä¿¡çš„åŒæ–¹å¯ä»¥åŒæ—¶å‘é€å’Œæ¥å—ä¿¡æ¯ã€‚**
- **SSE å®ç°ç®€å•å¼€å‘æˆæœ¬ä½ï¼Œæ— éœ€å¼•å…¥å…¶ä»–ç»„ä»¶ï¼›WebSocketä¼ è¾“æ•°æ®éœ€åšäºŒæ¬¡è§£æï¼Œå¼€å‘é—¨æ§›é«˜ä¸€äº›ã€‚**
- **SSE é»˜è®¤æ”¯æŒæ–­çº¿é‡è¿ï¼›WebSocketåˆ™éœ€è¦è‡ªå·±å®ç°ã€‚**
- **SSE åªèƒ½ä¼ é€æ–‡æœ¬æ¶ˆæ¯ï¼ŒäºŒè¿›åˆ¶æ•°æ®éœ€è¦ç»è¿‡ç¼–ç åä¼ é€ï¼›WebSocketé»˜è®¤æ”¯æŒä¼ é€äºŒè¿›åˆ¶æ•°æ®ã€‚**

**SSE ä¸ WebSocket è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ**
**â€œ**
æŠ€æœ¯å¹¶æ²¡æœ‰å¥½åä¹‹åˆ†ï¼Œåªæœ‰å“ªä¸ªæ›´åˆé€‚
SSEå¥½åƒä¸€ç›´ä¸è¢«å¤§å®¶æ‰€ç†ŸçŸ¥ï¼Œä¸€éƒ¨åˆ†åŸå› æ˜¯å‡ºç°äº†WebSocketsï¼Œè¿™ä¸ªæä¾›äº†æ›´ä¸°å¯Œçš„åè®®æ¥æ‰§è¡ŒåŒå‘ã€å…¨åŒå·¥é€šä¿¡ã€‚å¯¹äºæ¸¸æˆã€å³æ—¶é€šä¿¡ä»¥åŠéœ€è¦åŒå‘è¿‘ä¹å®æ—¶æ›´æ–°çš„åœºæ™¯ï¼Œæ‹¥æœ‰åŒå‘é€šé“æ›´å…·å¸å¼•åŠ›ã€‚
ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸éœ€è¦ä»å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚è€Œä½ åªéœ€è¦ä¸€äº›æœåŠ¡å™¨æ“ä½œçš„æ›´æ–°ã€‚æ¯”å¦‚ï¼šç«™å†…ä¿¡ã€æœªè¯»æ¶ˆæ¯æ•°ã€çŠ¶æ€æ›´æ–°ã€è‚¡ç¥¨è¡Œæƒ…ã€ç›‘æ§æ•°é‡ç­‰åœºæ™¯ï¼ŒSEEä¸ç®¡æ˜¯ä»å®ç°çš„éš¾æ˜“å’Œæˆæœ¬ä¸Šéƒ½æ›´åŠ æœ‰ä¼˜åŠ¿ã€‚æ­¤å¤–ï¼ŒSSE å…·æœ‰WebSocketsåœ¨è®¾è®¡ä¸Šç¼ºä¹çš„å¤šç§åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šè‡ªåŠ¨é‡æ–°è¿æ¥ã€äº‹ä»¶IDå’Œå‘é€ä»»æ„äº‹ä»¶çš„èƒ½åŠ›ã€‚
å‰ç«¯åªéœ€è¿›è¡Œä¸€æ¬¡HTTPè¯·æ±‚ï¼Œå¸¦ä¸Šå”¯ä¸€IDï¼Œæ‰“å¼€äº‹ä»¶æµï¼Œç›‘å¬æœåŠ¡ç«¯æ¨é€çš„äº‹ä»¶å°±å¯ä»¥äº†
```
<script>
    let source = null;
    let userId = 7777
    if (window.EventSource) {
        // å»ºç«‹è¿æ¥
        source = new EventSource('http://localhost:7777/sse/sub/'+userId);
        setMessageInnerHTML("è¿æ¥ç”¨æˆ·=" + userId);
        /**
         * è¿æ¥ä¸€æ—¦å»ºç«‹ï¼Œå°±ä¼šè§¦å‘openäº‹ä»¶
         * å¦ä¸€ç§å†™æ³•ï¼šsource.onopen = function (event) {}
         */
        source.addEventListener('open', function (e) {
            setMessageInnerHTML("å»ºç«‹è¿æ¥ã€‚ã€‚ã€‚");
        }, false);
        /**
         * å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘æ¥çš„æ•°æ®
         * å¦ä¸€ç§å†™æ³•ï¼šsource.onmessage = function (event) {}
         */
        source.addEventListener('message', function (e) {
            setMessageInnerHTML(e.data);
        });
    } else {
        setMessageInnerHTML("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒSSE");
    }
</script>
```
æœåŠ¡ç«¯çš„å®ç°æ›´ç®€å•ï¼Œåˆ›å»ºä¸€ä¸ªSseEmitterå¯¹è±¡æ”¾å…¥sseEmitterMapè¿›è¡Œç®¡ç†
```
private static Map<String, SseEmitter> sseEmitterMap = new ConcurrentHashMap<>();

/**
 * åˆ›å»ºè¿æ¥
 *
 * @date: 2022/7/12 14:51
 * @auther: ä½œè€…ï¼šå¾åº¶
 */
public static SseEmitter connect(String userId) {
    try {
        // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œ0è¡¨ç¤ºä¸è¿‡æœŸã€‚é»˜è®¤30ç§’
        SseEmitter sseEmitter = new SseEmitter(0L);
        // æ³¨å†Œå›è°ƒ
        sseEmitter.onCompletion(completionCallBack(userId));
        sseEmitter.onError(errorCallBack(userId));
        sseEmitter.onTimeout(timeoutCallBack(userId));
        sseEmitterMap.put(userId, sseEmitter);
        count.getAndIncrement();
        return sseEmitter;
    } catch (Exception e) {
        log.info("åˆ›å»ºæ–°çš„sseè¿æ¥å¼‚å¸¸ï¼Œå½“å‰ç”¨æˆ·ï¼š{}", userId);
    }
    return null;
}

/**
 * ç»™æŒ‡å®šç”¨æˆ·å‘é€æ¶ˆæ¯
 *
 * @date: 2022/7/12 14:51
 * @auther: ä½œè€…ï¼šå¾åº¶
 */
public static void sendMessage(String userId, String message) {

    if (sseEmitterMap.containsKey(userId)) {
        try {
            sseEmitterMap.get(userId).send(message);
        } catch (IOException e) {
            log.error("ç”¨æˆ·[{}]æ¨é€å¼‚å¸¸:{}", userId, e.getMessage());
            removeUser(userId);
        }
    }
}
```
æˆ‘ä»¬æ¨¡æ‹ŸæœåŠ¡ç«¯æ¨é€æ¶ˆæ¯ï¼Œçœ‹ä¸‹å®¢æˆ·ç«¯æ”¶åˆ°äº†æ¶ˆæ¯ï¼Œå’Œæˆ‘ä»¬é¢„æœŸçš„æ•ˆæœä¸€è‡´
ã€‚![1715003409191-54db0843-1230-4e25-9f92-8dc0e61a1fc1.gif](./img/3_UGzUXuAAUrsBku/1715003409191-54db0843-1230-4e25-9f92-8dc0e61a1fc1-425188.gif)
**æ³¨æ„ï¼š** SSEä¸æ”¯æŒIEæµè§ˆå™¨ï¼Œå¯¹å…¶ä»–ä¸»æµæµè§ˆå™¨å…¼å®¹æ€§åšçš„è¿˜ä¸é”™ã€‚
![1715003409124-6e75d283-f355-4a46-9f50-57be36980090.png](./img/3_UGzUXuAAUrsBku/1715003409124-6e75d283-f355-4a46-9f50-57be36980090-137677.png)

## MQTT
ä»€ä¹ˆæ˜¯ MQTTåè®®ï¼Ÿ
MQTT å…¨ç§°(Message Queue Telemetry Transport)ï¼šä¸€ç§åŸºäºå‘å¸ƒ/è®¢é˜…ï¼ˆpublish/subscribeï¼‰æ¨¡å¼çš„è½»é‡çº§é€šè®¯åè®®ï¼Œé€šè¿‡è®¢é˜…ç›¸åº”çš„ä¸»é¢˜æ¥è·å–æ¶ˆæ¯ï¼Œæ˜¯ç‰©è”ç½‘ï¼ˆInternet of Thingï¼‰ä¸­çš„ä¸€ä¸ªæ ‡å‡†ä¼ è¾“åè®®ã€‚
è¯¥åè®®å°†æ¶ˆæ¯çš„å‘å¸ƒè€…ï¼ˆpublisherï¼‰ä¸è®¢é˜…è€…ï¼ˆsubscriberï¼‰è¿›è¡Œåˆ†ç¦»ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸å¯é çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œä¸ºè¿œç¨‹è¿æ¥çš„è®¾å¤‡æä¾›å¯é çš„æ¶ˆæ¯æœåŠ¡ï¼Œä½¿ç”¨æ–¹å¼ä¸ä¼ ç»Ÿçš„MQæœ‰ç‚¹ç±»ä¼¼ã€‚
![1715003409299-a475795a-907c-494f-af39-735a51261ff2.png](./img/3_UGzUXuAAUrsBku/1715003409299-a475795a-907c-494f-af39-735a51261ff2-628779.png)
TCPåè®®ä½äºä¼ è¾“å±‚ï¼ŒMQTT åè®®ä½äºåº”ç”¨å±‚ï¼ŒMQTT åè®®æ„å»ºäºTCP/IPåè®®ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦æ”¯æŒTCP/IPåè®®æ ˆçš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨MQTTåè®®ã€‚
ä¸ºä»€ä¹ˆè¦ç”¨ MQTTåè®®ï¼Ÿ
MQTTåè®®ä¸ºä»€ä¹ˆåœ¨ç‰©è”ç½‘ï¼ˆIOTï¼‰ä¸­å¦‚æ­¤å—åçˆ±ï¼Ÿè€Œä¸æ˜¯å…¶å®ƒåè®®ï¼Œæ¯”å¦‚æˆ‘ä»¬æ›´ä¸ºç†Ÿæ‚‰çš„ HTTPåè®®å‘¢ï¼Ÿ

- **é¦–å…ˆHTTPåè®®å®ƒæ˜¯ä¸€ç§åŒæ­¥åè®®ï¼Œå®¢æˆ·ç«¯è¯·æ±‚åéœ€è¦ç­‰å¾…æœåŠ¡å™¨çš„å“åº”ã€‚è€Œåœ¨ç‰©è”ç½‘ï¼ˆIOTï¼‰ç¯å¢ƒä¸­ï¼Œè®¾å¤‡ä¼šå¾ˆå—åˆ¶äºç¯å¢ƒçš„å½±å“ï¼Œæ¯”å¦‚å¸¦å®½ä½ã€ç½‘ç»œå»¶è¿Ÿé«˜ã€ç½‘ç»œé€šä¿¡ä¸ç¨³å®šç­‰ï¼Œæ˜¾ç„¶å¼‚æ­¥æ¶ˆæ¯åè®®æ›´ä¸ºé€‚åˆIOTåº”ç”¨ç¨‹åºã€‚**
- **HTTPæ˜¯å•å‘çš„ï¼Œå¦‚æœè¦è·å–æ¶ˆæ¯å®¢æˆ·ç«¯å¿…é¡»å‘èµ·è¿æ¥ï¼Œè€Œåœ¨ç‰©è”ç½‘ï¼ˆIOTï¼‰åº”ç”¨ç¨‹åºä¸­ï¼Œè®¾å¤‡æˆ–ä¼ æ„Ÿå™¨å¾€å¾€éƒ½æ˜¯å®¢æˆ·ç«¯ï¼Œè¿™æ„å‘³ç€å®ƒä»¬æ— æ³•è¢«åŠ¨åœ°æ¥æ”¶æ¥è‡ªç½‘ç»œçš„å‘½ä»¤ã€‚**
- **é€šå¸¸éœ€è¦å°†ä¸€æ¡å‘½ä»¤æˆ–è€…æ¶ˆæ¯ï¼Œå‘é€åˆ°ç½‘ç»œä¸Šçš„æ‰€æœ‰è®¾å¤‡ä¸Šã€‚HTTPè¦å®ç°è¿™æ ·çš„åŠŸèƒ½ä¸ä½†å¾ˆå›°éš¾ï¼Œè€Œä¸”æˆæœ¬æé«˜ã€‚**

å…·ä½“çš„MQTTåè®®ä»‹ç»å’Œå®è·µï¼Œè¿™é‡Œæˆ‘å°±ä¸å†èµ˜è¿°äº†ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„ä¸¤ç¯‡æ–‡ç« ï¼Œé‡Œè¾¹å†™çš„ä¹Ÿéƒ½å¾ˆè¯¦ç»†äº†ã€‚
MQTTåè®®çš„ä»‹ç»
**æˆ‘ä¹Ÿæ²¡æƒ³åˆ° springboot + rabbitmq åšæ™ºèƒ½å®¶å±…ï¼Œä¼šè¿™ä¹ˆç®€å•**
MQTTå®ç°æ¶ˆæ¯æ¨é€
**æœªè¯»æ¶ˆæ¯ï¼ˆå°çº¢ç‚¹ï¼‰ï¼Œå‰ç«¯ ä¸ RabbitMQ å®æ—¶æ¶ˆæ¯æ¨é€å®è·µï¼Œè´¼ç®€å•~**

## Websocket
websocketåº”è¯¥æ˜¯å¤§å®¶éƒ½æ¯”è¾ƒç†Ÿæ‚‰çš„ä¸€ç§å®ç°æ¶ˆæ¯æ¨é€çš„æ–¹å¼ï¼Œä¸Šè¾¹æˆ‘ä»¬åœ¨è®²SSEçš„æ—¶å€™ä¹Ÿå’Œwebsocketè¿›è¡Œè¿‡æ¯”è¾ƒã€‚
WebSocketæ˜¯ä¸€ç§åœ¨TCPè¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ï¼Œå»ºç«‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡æ¸ é“ã€‚æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä»…éœ€ä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚
![1715003409445-78b5b3ac-7247-4109-bcac-960f5dfbc971.png](./img/3_UGzUXuAAUrsBku/1715003409445-78b5b3ac-7247-4109-bcac-960f5dfbc971-006590.png)
å›¾ç‰‡æºäºç½‘ç»œ
springbootæ•´åˆwebsocketï¼Œå…ˆå¼•å…¥websocketç›¸å…³çš„å·¥å…·åŒ…ï¼Œå’ŒSSEç›¸æ¯”é¢å¤–çš„å¼€å‘æˆæœ¬ã€‚
```
<!-- å¼•å…¥websocket -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```
æœåŠ¡ç«¯ä½¿ç”¨@ServerEndpointæ³¨è§£æ ‡æ³¨å½“å‰ç±»ä¸ºä¸€ä¸ªwebsocketæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ws://localhost:7777/webSocket/10086æ¥è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ç«¯ã€‚
```
@Component
@Slf4j
@ServerEndpoint("/websocket/{userId}")
public class WebSocketServer {
    //ä¸æŸä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ä¼šè¯ï¼Œéœ€è¦é€šè¿‡å®ƒæ¥ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®
    private Session session;
    private static final CopyOnWriteArraySet<WebSocketServer> webSockets = new CopyOnWriteArraySet<>();
    // ç”¨æ¥å­˜åœ¨çº¿è¿æ¥æ•°
    private static final Map<String, Session> sessionPool = new HashMap<String, Session>();
    /**
     * ä½œè€…ï¼šå¾åº¶
     * é“¾æ¥æˆåŠŸè°ƒç”¨çš„æ–¹æ³•
     */
    @OnOpen
    public void onOpen(Session session, @PathParam(value = "userId") String userId) {
        try {
            this.session = session;
            webSockets.add(this);
            sessionPool.put(userId, session);
            log.info("websocketæ¶ˆæ¯: æœ‰æ–°çš„è¿æ¥ï¼Œæ€»æ•°ä¸º:" + webSockets.size());
        } catch (Exception e) {
        }
    }
    /**
     * ä½œè€…ï¼šå¾åº¶
     * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³•
     */
    @OnMessage
    public void onMessage(String message) {
        log.info("websocketæ¶ˆæ¯: æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯:" + message);
    }
    /**
     * ä½œè€…ï¼šå¾åº¶
     * æ­¤ä¸ºå•ç‚¹æ¶ˆæ¯
     */
    public void sendOneMessage(String userId, String message) {
        Session session = sessionPool.get(userId);
        if (session != null && session.isOpen()) {
            try {
                log.info("websocketæ¶ˆ: å•ç‚¹æ¶ˆæ¯:" + message);
                session.getAsyncRemote().sendText(message);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```
å‰ç«¯åˆå§‹åŒ–æ‰“å¼€WebSocketè¿æ¥ï¼Œå¹¶ç›‘å¬è¿æ¥çŠ¶æ€ï¼Œæ¥æ”¶æœåŠ¡ç«¯æ•°æ®æˆ–å‘æœåŠ¡ç«¯å‘é€æ•°æ®ã€‚
```
<script>
    var ws = new WebSocket('ws://localhost:7777/webSocket/10086');
    // è·å–è¿æ¥çŠ¶æ€
    console.log('wsè¿æ¥çŠ¶æ€ï¼š' + ws.readyState);
    //ç›‘å¬æ˜¯å¦è¿æ¥æˆåŠŸ
    ws.onopen = function () {
        console.log('wsè¿æ¥çŠ¶æ€ï¼š' + ws.readyState);
        //è¿æ¥æˆåŠŸåˆ™å‘é€ä¸€ä¸ªæ•°æ®
        ws.send('test1');
    }
    // æ¥å¬æœåŠ¡å™¨å‘å›çš„ä¿¡æ¯å¹¶å¤„ç†å±•ç¤º
    ws.onmessage = function (data) {
        console.log('æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡å™¨çš„æ¶ˆæ¯ï¼š');
        console.log(data);
        //å®Œæˆé€šä¿¡åå…³é—­WebSocketè¿æ¥
        ws.close();
    }
    // ç›‘å¬è¿æ¥å…³é—­äº‹ä»¶
    ws.onclose = function () {
        // ç›‘å¬æ•´ä¸ªè¿‡ç¨‹ä¸­websocketçš„çŠ¶æ€
        console.log('wsè¿æ¥çŠ¶æ€ï¼š' + ws.readyState);
    }
    // ç›‘å¬å¹¶å¤„ç†erroräº‹ä»¶
    ws.onerror = function (error) {
        console.log(error);
    }
    function sendMessage() {
        var content = $("#message").val();
        $.ajax({
            url: '/socket/publish?userId=10086&message=' + content,
            type: 'GET',
            data: { "id": "7777", "content": content },
            success: function (data) {
                console.log(data)
            }
        })
    }
</script>
```
é¡µé¢åˆå§‹åŒ–å»ºç«‹websocketè¿æ¥ï¼Œä¹‹åå°±å¯ä»¥è¿›è¡ŒåŒå‘é€šä¿¡äº†ï¼Œæ•ˆæœè¿˜ä¸é”™
![1715003409471-fc6a1fa9-1267-44e8-a399-39870cdacf03.png](./img/3_UGzUXuAAUrsBku/1715003409471-fc6a1fa9-1267-44e8-a399-39870cdacf03-841465.png)
![1715003409595-d16f445e-dcc0-4d54-bcc0-f71cc9d348c0.gif](./img/3_UGzUXuAAUrsBku/1715003409595-d16f445e-dcc0-4d54-bcc0-f71cc9d348c0-642094.gif)

## è‡ªå®šä¹‰æ¨é€
ä¸Šè¾¹æˆ‘ä»¬ç»™æˆ‘å‡ºäº†6ç§æ–¹æ¡ˆçš„åŸç†å’Œä»£ç å®ç°ï¼Œä½†åœ¨å®é™…ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½ç›²ç›®çš„ç›´æ¥æ‹¿è¿‡æ¥ç”¨ï¼Œè¿˜æ˜¯è¦ç»“åˆè‡ªèº«ç³»ç»Ÿä¸šåŠ¡çš„ç‰¹ç‚¹å’Œå®é™…åœºæ™¯æ¥é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚
æ¨é€æœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ç¬¬ä¸‰æ¨é€å¹³å°ï¼Œæ¯•ç«Ÿ**é’±èƒ½è§£å†³çš„éœ€æ±‚éƒ½ä¸æ˜¯é—®é¢˜**ï¼Œæ— éœ€å¤æ‚çš„å¼€å‘è¿ç»´ï¼Œç›´æ¥å¯ä»¥ä½¿ç”¨ï¼Œçœæ—¶ã€çœåŠ›ã€çœå¿ƒï¼ŒåƒgoEasyã€æå…‰æ¨é€éƒ½æ˜¯å¾ˆä¸é”™çš„ä¸‰æ–¹æœåŠ¡å•†ã€‚
ä¸€èˆ¬å¤§å‹å…¬å¸éƒ½æœ‰è‡ªç ”çš„æ¶ˆæ¯æ¨é€å¹³å°ï¼Œåƒæˆ‘ä»¬æœ¬æ¬¡å®ç°çš„webç«™å†…ä¿¡åªæ˜¯å¹³å°ä¸Šçš„ä¸€ä¸ªè§¦ç‚¹è€Œå·²ï¼ŒçŸ­ä¿¡ã€é‚®ä»¶ã€å¾®ä¿¡å…¬ä¼—å·ã€å°ç¨‹åºå‡¡æ˜¯å¯ä»¥è§¦è¾¾åˆ°ç”¨æˆ·çš„æ¸ é“éƒ½å¯ä»¥æ¥å…¥è¿›æ¥ã€‚
![1715003409719-668e53ca-c4fc-4f59-bbae-1f65dc9e032d.png](./img/3_UGzUXuAAUrsBku/1715003409719-668e53ca-c4fc-4f59-bbae-1f65dc9e032d-564781.png)
å›¾ç‰‡æ¥æºäºç½‘ç»œ
æ¶ˆæ¯æ¨é€ç³»ç»Ÿå†…éƒ¨æ˜¯ç›¸å½“å¤æ‚çš„ï¼Œè¯¸å¦‚æ¶ˆæ¯å†…å®¹çš„ç»´æŠ¤å®¡æ ¸ã€åœˆå®šæ¨é€äººç¾¤ã€è§¦è¾¾è¿‡æ»¤æ‹¦æˆªï¼ˆæ¨é€çš„è§„åˆ™é¢‘æ¬¡ã€æ—¶æ®µã€æ•°é‡ã€é»‘ç™½åå•ã€å…³é”®è¯ç­‰ç­‰ï¼‰ã€æ¨é€å¤±è´¥è¡¥å¿éå¸¸å¤šçš„æ¨¡å—ï¼ŒæŠ€æœ¯ä¸Šæ¶‰åŠåˆ°å¤§æ•°æ®é‡ã€é«˜å¹¶å‘çš„åœºæ™¯ä¹Ÿå¾ˆå¤šã€‚æ‰€ä»¥æˆ‘ä»¬ä»Šå¤©çš„å®ç°æ–¹å¼åœ¨è¿™ä¸ªåºå¤§çš„ç³»ç»Ÿé¢å‰åªæ˜¯å°æ‰“å°é—¹ã€‚

# è½»æ¾ææ‡‚IOå¤šè·¯å¤ç”¨

## ä»€ä¹ˆæ˜¯ IO å¤šè·¯å¤ç”¨ï¼Ÿ
å…ˆè¯´ç»“è®ºï¼ŒIO å¤šè·¯å¤ç”¨æ˜¯ä¸€ç§åœ¨å•ä¸ªçº¿ç¨‹ä¸­ç®¡ç†å¤šä¸ª IO æ“ä½œçš„æŠ€æœ¯ã€‚å®ƒå…è®¸ä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”åœ¨å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼ˆå¯è¯»ã€å¯å†™æˆ–å¼‚å¸¸ï¼‰æ—¶æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œè€Œæ— éœ€é˜»å¡å…¶ä»–æ“ä½œã€‚

---

è¿™æ ·å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œæˆ‘ä»¬çœ‹çœ‹æ²¡æœ‰ IO å¤šè·¯å¤ç”¨æ—¶ï¼ŒBIO NIO æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚
å¦‚æœç°åœ¨æœ‰ 1W ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼š

- **BIO çš„å¤„ç†é€»è¾‘**
   - æœåŠ¡ç«¯é‡‡ç”¨å•çº¿ç¨‹ï¼Œå½“ accept ä¸€ä¸ªè¯·æ±‚åï¼Œåœ¨ recv æˆ– send è°ƒç”¨é˜»å¡æ—¶ï¼Œå°†æ— æ³• accept å…¶ä»–è¯·æ±‚ï¼ˆå¿…é¡»ç­‰ä¸Šä¸€ä¸ªè¯·æ±‚å¤„ recv æˆ– send å®Œï¼‰ï¼Œæ— æ³•å¤„ç†å¹¶å‘ã€‚
   - æœåŠ¡ç«¯é‡‡ç”¨å¤šçº¿ç¨‹ï¼Œå½“ accept ä¸€ä¸ªè¯·æ±‚åï¼Œå¼€å¯çº¿ç¨‹è¿›è¡Œ recvï¼Œå¯ä»¥å®Œæˆå¹¶å‘å¤„ç†ï¼Œä½†éšç€è¯·æ±‚æ•°å¢åŠ éœ€è¦å¢åŠ ç³»ç»Ÿçº¿ç¨‹ï¼Œå¤§é‡çš„çº¿ç¨‹å ç”¨å¾ˆå¤§çš„å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”çº¿ç¨‹åˆ‡æ¢ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ï¼Œ1W ä¸ªçº¿ç¨‹çœŸæ­£å‘ç”Ÿè¯»å†™äº‹ä»¶çš„çº¿ç¨‹æ•°ä¸ä¼šè¶…è¿‡20%ï¼Œæ¯æ¬¡  accept éƒ½å¼€ä¸€ä¸ªçº¿ç¨‹ä¹Ÿæ˜¯ä¸€ç§èµ„æºæµªè´¹
- **NIO çš„å¤„ç†é€»è¾‘**
   - æœåŠ¡å™¨ç«¯å½“ accept ä¸€ä¸ªè¯·æ±‚åï¼ŒåŠ å…¥ fds é›†åˆï¼ˆæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼‰ï¼Œæ¯æ¬¡è½®è¯¢ä¸€é fds é›†åˆ recv (éé˜»å¡) æ•°æ®ï¼Œæ²¡æœ‰æ•°æ®åˆ™ç«‹å³è¿”å›é”™è¯¯ï¼Œæ¯æ¬¡è½®è¯¢æ‰€æœ‰ fdï¼ˆåŒ…æ‹¬æ²¡æœ‰å‘ç”Ÿè¯»å†™äº‹ä»¶çš„ fd ï¼‰ä¼šå¾ˆæµªè´¹ cpu èµ„æº
- **IOå¤šè·¯å¤ç”¨å¤„ç†é€»è¾‘**
   - æœåŠ¡å™¨ç«¯é‡‡ç”¨å•çº¿ç¨‹é€šè¿‡ select/epoll ç­‰ç³»ç»Ÿè°ƒç”¨è·å– fd åˆ—è¡¨ï¼Œéå†æœ‰äº‹ä»¶çš„ fd è¿›è¡Œaccept/recv/sendï¼Œä½¿å…¶èƒ½æ”¯æŒæ›´å¤šçš„å¹¶å‘è¿æ¥è¯·æ±‚ã€‚
   - ç›¸æ¯”äº BIOã€NIOï¼ŒIO å¤šè·¯å¤ç”¨æœ€å¤§çš„åŒºåˆ«å°±æ˜¯**è·å–æœ‰äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ–¹å¼å‘ç”Ÿäº†è½¬å˜**ï¼ŒBIOï¼ŒNIO éƒ½æ˜¯ä¸»åŠ¨å»è½®è¯¢è·å– fdï¼Œå¤šè·¯å¤ç”¨æ˜¯å°† **fd éƒ½äº¤ç»™å†…æ ¸å»ç›‘æ§**ï¼Œå½“æŸä¸ª fd èƒ½å¤Ÿè¯»å†™æ—¶ç”±å†…æ ¸å‘ŠçŸ¥åº”ç”¨ç¨‹åºå¤„ç†ï¼Œè¿™æ ·å°±ä»**ä¸»åŠ¨è½®è¯¢å˜æˆäº†æ¸…é—²çš„è¢«åŠ¨**äº†ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ç°åœ¨å°±å¯ä»¥ä¸€æ¬¡å¤„ç†å¤šè·¯ IO äº†**ã€‚**

---

accept ç”¨äºå»ºç«‹è¿æ¥ï¼Œrecv ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œsend ç”¨äºå‘å®¢æˆ·ç«¯å‘é€æ•°æ®

---

åˆšåˆšæˆ‘ä»¬æåˆ°çš„ I/O æ“ä½œéƒ½æ˜¯é’ˆå¯¹æ–‡ä»¶æè¿°ç¬¦çš„ï¼Œé‚£ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦å‘¢ï¼Ÿ

## ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Ÿ
å¾ˆç®€å•ï¼Œæ–‡ä»¶æè¿°ç¬¦å…¶å®å°±æ˜¯ä¸€ä¸ªæ•°å­—è€Œå·²ï¼Œåˆæˆ–è€…å¯ä»¥ç†è§£ä¸ºæŒ‡é’ˆã€‚
æåˆ° I/O æ“ä½œå°±é€ƒä¸è¿‡æ–‡ä»¶è¿™ä¸ªæ¦‚å¿µï¼Œåœ¨ Linux ä¸­æœ‰ä¸€ä¸ªå¾ˆç»å…¸çš„è¯´æ³• everything is fileï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼šæ–‡ä»¶IOã€ç½‘ç»œIOã€ç®¡é“IO ç­‰ç­‰ã€‚é‚£æˆ‘ä»¬åœ¨è¿›è¡Œ I/O æ“ä½œçš„æ—¶å€™ï¼Œæ˜¯æ€ä¹ˆçŸ¥é“ä»å“ªä¸ªæ–‡ä»¶è¯»æ•°æ®ï¼Œå¾€å“ªä¸ªæ–‡ä»¶å†™æ•°æ®çš„å‘¢ï¼Ÿè¿™æ—¶å€™å°±æ˜¯é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥æ‰¾åˆ°ç¡®åˆ‡çš„æ–‡ä»¶ã€‚**æœ‰äº†æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿›ç¨‹å¯ä»¥å¯¹æ–‡ä»¶ä¸€æ— æ‰€çŸ¥**ï¼Œæ¯”å¦‚æ–‡ä»¶åœ¨ç£ç›˜çš„ä»€ä¹ˆä½ç½®ã€åŠ è½½åˆ°å†…å­˜ä¸­åˆæ˜¯æ€æ ·ç®¡ç†çš„ç­‰ç­‰ï¼Œè¿™äº›ä¿¡æ¯ç»Ÿç»Ÿäº¤ç”±æ“ä½œç³»ç»Ÿæ‰“ç†ï¼Œè¿›ç¨‹æ— éœ€å…³å¿ƒï¼Œæ“ä½œç³»ç»Ÿåªéœ€è¦ç»™è¿›ç¨‹ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å°±è¶³å¤Ÿäº†ã€‚

# HTTP å’Œ RPC æ¥å£åŒºåˆ«
HTTP ä¸ RPC æ¥å£æ˜¯ä¸¤ç§å¸¸è§çš„æ¥å£é€šä¿¡åè®®ã€‚æœ¬æ–‡å°†ä¼šä»‹ç»å®ƒä»¬çš„å®šä¹‰ï¼ŒåŒºåˆ«å’Œç›¸åŒä¹‹å¤„ï¼Œåº”ç”¨åœºæ™¯ã€‚

## HTTP æ¥å£
HTTP æ˜¯ä¸€ç§åº”ç”¨å±‚é€šä¿¡åè®®ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨æœåŠ¡å™¨å’Œ Web æµè§ˆå™¨ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚HTTPçš„æ ¸å¿ƒæ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œå¹¶ç­‰å¾…æœåŠ¡å™¨çš„å“åº”ã€‚

- åœ¨ Web åº”ç”¨ä¸­ï¼ŒHTTP ä¸»è¦ç”¨äºä¼ è¾“ HTMLã€CSSã€JavaScript ç­‰Webèµ„æºã€‚
- åœ¨æ¥å£è®¾è®¡æ–¹é¢ï¼ŒHTTP æ¥å£é€šå¸¸ä½¿ç”¨ RESTful æ¶æ„ã€‚RESTful æ¶æ„æ˜¯ä¸€ç§è®¾è®¡é£æ ¼ï¼Œé€šè¿‡ä½¿ç”¨ HTTP æ–¹æ³•ï¼ˆå¦‚GETã€POSTã€PUTã€DELETEç­‰ï¼‰å’Œç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼ˆURIï¼‰æ¥å®šä¹‰èµ„æºå’Œæ“ä½œã€‚é‡‡ç”¨ RESTful æ¶æ„å¯ä»¥ä½¿ HTTP æ¥å£å…·æœ‰è‰¯å¥½çš„å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

## RPC æ¥å£
RPCï¼ˆRemote Procedure Callï¼‰æ˜¯ä¸€ç§è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºé€šè¿‡ç½‘ç»œè°ƒç”¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å‡½æ•°æˆ–è¿‡ç¨‹ã€‚

- RPCæ¥å£é€šå¸¸åˆ©ç”¨äºŒè¿›åˆ¶åè®®è¿›è¡Œé€šä¿¡ï¼Œæ¯”å¦‚ProtoBufã€Thriftã€Msgpackç­‰ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨HTTPåè®®æˆ–TCPåè®®ç­‰å…¶ä»–æ–¹å¼ã€‚
- åœ¨æ¥å£è®¾è®¡æ–¹é¢ï¼ŒRPCæ¥å£é€šå¸¸ä½¿ç”¨æ¥å£å®šä¹‰è¯­è¨€ï¼ˆIDLï¼‰æ¥æè¿°ã€‚IDLæ˜¯ä¸€ç§æè¿°æ¥å£å’Œæ•°æ®ç»“æ„çš„è¯­è¨€ï¼Œå®ƒå¯ä»¥å°†æ¥å£å’Œæ•°æ®ç»“æ„å®šä¹‰è½¬æ¢ä¸ºå¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œä»è€Œæ–¹ä¾¿ä¸åŒç¼–ç¨‹è¯­è¨€ä¹‹é—´çš„æ¥å£é€šä¿¡ã€‚

## HTTP æ¥å£ä¸ RPC æ¥å£çš„åŒºåˆ«å’Œç›¸åŒä¹‹å¤„

1. **é€šä¿¡åè®®ä¸åŒï¼š**HTTP ä½¿ç”¨æ–‡æœ¬åè®®ï¼ŒRPC ä½¿ç”¨äºŒè¿›åˆ¶åè®®ã€‚
2. **è°ƒç”¨æ–¹å¼ä¸åŒï¼š**HTTP æ¥å£é€šè¿‡ URL è¿›è¡Œè°ƒç”¨ï¼ŒRPC æ¥å£é€šè¿‡å‡½æ•°è°ƒç”¨è¿›è¡Œè°ƒç”¨ã€‚
3. **å‚æ•°ä¼ é€’æ–¹å¼ä¸åŒï¼š**HTTP æ¥å£ä½¿ç”¨ URL å‚æ•°æˆ–è€…è¯·æ±‚ä½“è¿›è¡Œå‚æ•°ä¼ é€’ï¼ŒRPC æ¥å£ä½¿ç”¨å‡½æ•°å‚æ•°è¿›è¡Œä¼ é€’ã€‚
4. **æ¥å£æè¿°æ–¹å¼ä¸åŒï¼š**HTTP æ¥å£ä½¿ç”¨ RESTful æ¶æ„æè¿°æ¥å£ï¼ŒRPC æ¥å£ä½¿ç”¨æ¥å£å®šä¹‰è¯­è¨€ï¼ˆIDLï¼‰æè¿°æ¥å£ã€‚
5. **æ€§èƒ½è¡¨ç°ä¸åŒï¼š**RPC æ¥å£é€šå¸¸æ¯” HTTP æ¥å£æ›´å¿«ï¼Œå› ä¸ºå®ƒä½¿ç”¨äºŒè¿›åˆ¶åè®®è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸”ä½¿ç”¨äº†ä¸€äº›æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œä¾‹å¦‚è¿æ¥æ± ã€æ‰¹å¤„ç†ç­‰ã€‚æ­¤å¤–ï¼ŒRPC æ¥å£é€šå¸¸æ”¯æŒå¼‚æ­¥è°ƒç”¨ï¼Œå¯ä»¥æ›´å¥½åœ°å¤„ç†é«˜å¹¶å‘åœºæ™¯ã€‚

HTTP æ¥å£å’Œ RPC æ¥å£çš„ç›¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä»¬éƒ½æ˜¯ç”¨äºæ¥å£é€šä¿¡çš„åè®®ã€‚å®ƒä»¬éƒ½éœ€è¦å®šä¹‰æ¥å£ã€å‚æ•°å’Œè¿”å›å€¼ç­‰ä¿¡æ¯ï¼Œå¹¶é€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚æ­¤å¤–ï¼Œå®ƒä»¬éƒ½æ”¯æŒå¤šç§æ•°æ®æ ¼å¼çš„ç¼–è§£ç ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è¿›è¡Œçµæ´»çš„é€‰æ‹©ã€‚

## HTTP æ¥å£å’Œ RPC æ¥å£çš„åº”ç”¨åœºæ™¯
HTTP æ¥å£é€‚ç”¨äº Web åº”ç”¨ç¨‹åºå’Œæµè§ˆå™¨ä¹‹é—´çš„é€šä¿¡ã€‚å®ƒé€šå¸¸ç”¨äºä¼ è¾“ HTMLã€CSSã€JavaScript å’Œå…¶ä»– Web èµ„æºï¼Œä»¥åŠ RESTful é£æ ¼çš„ API æœåŠ¡ã€‚
RPC æ¥å£é€‚ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ã€‚å®ƒå¯ä»¥åœ¨å¤šç§ç¼–ç¨‹è¯­è¨€ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œæ”¯æŒå¤šç§åè®®å’Œæ•°æ®æ ¼å¼ã€‚RPC æ¥å£é€šå¸¸ç”¨äºå¤„ç†é«˜å¹¶å‘ã€é«˜ååé‡çš„åœºæ™¯ï¼Œä¾‹å¦‚å¤§å‹çš„åˆ†å¸ƒå¼è®¡ç®—ã€å¤§æ•°æ®å¤„ç†ç­‰ã€‚

# ä»€ä¹ˆæ˜¯æ­£å‘ä»£ç†ä¸åå‘ä»£ç†ï¼Ÿ

## ä»€ä¹ˆæ˜¯ä»£ç†ï¼Ÿ

### ![æ­£å‘ä»£ç†.png](./img/3_UGzUXuAAUrsBku/1716887047399-3042cb84-86ac-4206-b94b-83dcd3ef22e2-652370.png)
ä»£ç†æ˜¯ä¸€ç§ç½‘ç»œæœåŠ¡æ¨¡å¼ï¼Œå®ƒå……å½“å®¢æˆ·ç«¯å’Œç›®æ ‡æœåŠ¡å™¨ä¹‹é—´çš„ä¸­ä»‹ã€‚åœ¨ä»£ç†æœåŠ¡å™¨çš„æ¨¡å‹ä¸­ï¼Œå®¢æˆ·ç«¯ä¸ç›´æ¥ä¸ç›®æ ‡æœåŠ¡å™¨é€šä¿¡ï¼Œè€Œæ˜¯å°†è¯·æ±‚å‘é€åˆ°ä»£ç†æœåŠ¡å™¨ï¼Œç„¶åä»£ç†æœåŠ¡å™¨å°†è¯·æ±‚è½¬å‘ç»™ç›®æ ‡æœåŠ¡å™¨ã€‚ç›®æ ‡æœåŠ¡å™¨çš„å“åº”ä¹Ÿé€šè¿‡ä»£ç†æœåŠ¡å™¨è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
ä»£ç†çš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š

1. è®¿é—®æ§åˆ¶ï¼šä»£ç†å¯ä»¥æ§åˆ¶å¯¹ç‰¹å®šèµ„æºçš„è®¿é—®ï¼Œå®æ–½å®‰å…¨ç­–ç•¥ã€‚
2. æ€§èƒ½ä¼˜åŒ–ï¼šä»£ç†å¯ä»¥ç¼“å­˜å¸¸è§è¯·æ±‚çš„ç»“æœï¼Œå‡å°‘æœåŠ¡å™¨è´Ÿè½½ï¼ŒåŠ å¿«å“åº”é€Ÿåº¦ã€‚
3. åŒ¿åæ€§ï¼šä»£ç†å¯ä»¥éšè—å®¢æˆ·ç«¯çš„çœŸå®èº«ä»½ï¼Œæä¾›ä¸€å®šç¨‹åº¦çš„åŒ¿åæ€§ã€‚
4. å†…å®¹è¿‡æ»¤ï¼šä»£ç†å¯ä»¥è¿‡æ»¤è¯·æ±‚å’Œå“åº”ï¼Œä¾‹å¦‚å±è”½ä¸è‰¯ç½‘ç«™æˆ–æ•°æ®ã€‚
5. ç›‘æ§ï¼šä»£ç†å¯ä»¥ç›‘æ§ç½‘ç»œæµé‡ï¼Œè®°å½•è®¿é—®æ—¥å¿—ã€‚

## ä»€ä¹ˆæ˜¯åå‘ä»£ç†ï¼Ÿ

### ![åå‘ä»£ç†.png](./img/3_UGzUXuAAUrsBku/1716887051179-b835faad-a9a6-4bb5-add7-63e100c5e7de-883472.png)
åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰æ˜¯ä»£ç†æœåŠ¡å™¨çš„å¦ä¸€ç§å½¢å¼ï¼Œå®ƒä½äºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´ï¼Œä½†æ˜¯å®¢æˆ·ç«¯é€šå¸¸ä¸çŸ¥é“åå‘ä»£ç†çš„å­˜åœ¨ã€‚åœ¨è¿™ç§æ¨¡å‹ä¸­ï¼Œå®¢æˆ·ç«¯å‘èµ·çš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾åå‘ä»£ç†æœåŠ¡å™¨ï¼Œç„¶ååå‘ä»£ç†æœåŠ¡å™¨å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„ä¸€ç»„æœåŠ¡å™¨ä¹‹ä¸€ã€‚æœåŠ¡å™¨çš„å“åº”å†é€šè¿‡åå‘ä»£ç†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
åå‘ä»£ç†çš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š

1. è´Ÿè½½å‡è¡¡ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªåç«¯æœåŠ¡å™¨ï¼Œå¹³è¡¡è´Ÿè½½ã€‚
2. æ•…éšœè½¬ç§»ï¼šåœ¨åç«¯æœåŠ¡å™¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œè‡ªåŠ¨å°†æµé‡åˆ‡æ¢åˆ°å¥åº·çš„æœåŠ¡å™¨ã€‚
3. SSLç»ˆç«¯ï¼šå¤„ç†SSLåŠ å¯†å’Œè§£å¯†ï¼Œå‡è½»åç«¯æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚
4. ç¼“å­˜é™æ€å†…å®¹ï¼šç¼“å­˜ä¸ç»å¸¸å˜åŒ–çš„å†…å®¹ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚
5. è®¿é—®æ§åˆ¶ï¼šæ§åˆ¶å¯¹åç«¯æœåŠ¡å™¨çš„è®¿é—®ã€‚
6. éšè—æœåŠ¡å™¨ç»†èŠ‚ï¼šä¸å‘å®¢æˆ·ç«¯æš´éœ²åç«¯æœåŠ¡å™¨çš„å…·ä½“ä¿¡æ¯ã€‚

## åå‘ä»£ç†å°±æ˜¯è´Ÿè½½å‡è¡¡å—ï¼Ÿ
è™½ç„¶åå‘ä»£ç†å¯ä»¥æ‰§è¡Œè´Ÿè½½å‡è¡¡çš„ä»»åŠ¡ï¼Œä½†å®ƒä»¬å¹¶ä¸å®Œå…¨ç›¸åŒã€‚è´Ÿè½½å‡è¡¡æ˜¯ä¸€ç§å°†å·¥ä½œé‡ï¼ˆå¦‚ç½‘ç»œæµé‡ï¼‰å¹³å‡åˆ†é…åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šçš„æ¦‚å¿µï¼Œä»¥ä¼˜åŒ–èµ„æºä½¿ç”¨ã€æœ€å¤§åŒ–ååé‡ã€æœ€å°åŒ–å“åº”æ—¶é—´ï¼Œå¹¶é¿å…è¿‡è½½ä»»ä½•å•ä¸€æœåŠ¡å™¨ã€‚
åå‘ä»£ç†é€šå¸¸åŒ…å«è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œä½†å®ƒæä¾›æ›´å¤šé¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚SSLç»ˆç«¯ã€ç¼“å­˜ã€è®¿é—®æ§åˆ¶ç­‰ã€‚å› æ­¤ï¼Œå¯ä»¥è¯´åå‘ä»£ç†æ˜¯ä¸€ç§å¤šåŠŸèƒ½çš„ç½‘ç»œæœåŠ¡ï¼Œå®ƒåŒ…å«äº†è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œä½†ä¸é™äºæ­¤ã€‚

 


> åŸæ–‡: <https://www.yuque.com/tulingzhouyu/db22bv/om32fi26bha6ufgm>